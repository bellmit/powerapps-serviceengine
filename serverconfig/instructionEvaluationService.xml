<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="instructionEvaluationService">

	<resultMap class="hmap" id="getLegalInstructionEvaluationTree" extends="global.ref">
		<result property="IS_BATCH" javaType="boolean"/>
	</resultMap>
	
	<select id="getLegalInstructionEvaluationTree" resultMap="getLegalInstructionEvaluationTree">
		<include refid="refselect" /> ,is_batch 
		FROM PTRLEGAL_INSTRUCTION_TREE
		WHERE SUBTYPE_ID =#SUBTYPE_ID# 
		<isNotNull property="PRODUCT_CATEGORY_ID">and PRODUCT_CATEGORY_ID=#PRODUCT_CATEGORY_ID#</isNotNull> 
		AND DISABLE =<include refid="false"/>
		order by id desc
	</select>
	
	<resultMap id="getInstructionEvaluationTreeDocumentId" class="hmap">
		<result property="DOCUMENT_ID" javaType="long" />
	</resultMap>
	<select id="getInstructionEvaluationTreeDocumentId" resultMap="getInstructionEvaluationTreeDocumentId">
		SELECT DOCUMENT_ID FROM PTRLEGAL_INSTRUCTION_TREE WHERE ID=#ID#	
	</select>
	
	<resultMap id="getInstructionTreeForEditing" class="hmap">
		<result property="CODE" javaType="string" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="SUBTYPE_ID" javaType="long" />
		<result property="PRODUCT_CATEGORY_ID" javaType="long" />
		<result property="IS_BATCH" javaType="boolean" />
		<result property="SEND_VERIFICATION" javaType="boolean" />
		<result property="DISABLE" javaType="boolean" />
	</resultMap>
	<select id="getInstructionTreeForEditing" resultMap="getInstructionTreeForEditing">
		SELECT CODE,DESCRIPTION,SUBTYPE_ID,PRODUCT_CATEGORY_ID,IS_BATCH,SEND_VERIFICATION,DISABLE
		FROM PTRLEGAL_INSTRUCTION_TREE
		WHERE ID = #ID#	
	</select>	

	<update id="setInstructionTreesIsBatchToFalseBySubtype">
	update PTRLEGAL_INSTRUCTION_TREE set is_batch = <include refid="false"/>
	where subtype_id = #SUBTYPE_ID#
	<isNotNull property="PRODUCT_CATEGORY_ID">and PRODUCT_CATEGORY_ID=#PRODUCT_CATEGORY_ID#</isNotNull>
	</update>

	<update id="updateInstructionEvaluationTree">
		UPDATE PTRLEGAL_INSTRUCTION_TREE SET
		CODE = #CODE#,
		DESCRIPTION = #DESCRIPTION#,
		SUBTYPE_ID =#SUBTYPE_ID#,
		PRODUCT_CATEGORY_ID=#PRODUCT_CATEGORY_ID#,
		IS_BATCH = #IS_BATCH#,
		SEND_VERIFICATION = #SEND_VERIFICATION#,
		REMARKS = #REMARKS#,
		DISABLE = #DISABLE#,
		UPDATED_BY = #LOGON_USER#,
		UPDATED_TIME =#CURRENT_TIME#
		WHERE ID=#ID#	
	</update>

	<insert id="insertInstructionEvaluationTree">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRLEGAL_INSTRUCTION_TREE_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRLEGAL_INSTRUCTION_TREE(ID,CODE,DESCRIPTION,IS_BATCH,SEND_VERIFICATION,SUBTYPE_ID,PRODUCT_CATEGORY_ID,REMARKS,SORT_PRIORITY,CREATED_TIME,CREATED_BY)
		VALUES(#ID#,#CODE#,#DESCRIPTION#,#IS_BATCH#,#SEND_VERIFICATION#,#SUBTYPE_ID#,#PRODUCT_CATEGORY_ID#,#REMARKS#,#ID#,#CURRENT_TIME#,#LOGON_USER#)	
	</insert>	
	
	<update id="updateInstructionEvaluationTreeContent">
		UPDATE PTRLEGAL_INSTRUCTION_TREE SET DOCUMENT_ID = #DOCUMENT_ID#, 
		REMARKS = #REMARKS#, UPDATED_BY = #LOGON_USER#, UPDATED_TIME =#CURRENT_TIME#
		WHERE ID =#ID#
	</update>
	<select id="getInstructionEvaluationTreeBuckets" resultMap="global.ref">
		<include refid="refselect" /> 
		FROM PTRINSTRUCTED_ACTION_REF
	</select>	
	
	<select id="getVisualActionEvaluationTreeBuckets" resultMap="global.ref">
		<include refid="refselect" /> 
		FROM PTRLEGAL_ACTION_REF where SUBTYPE_ID=#SUBTYPE_ID# AND visual_action=<include refid="true"/>
	</select>	
</sqlMap>