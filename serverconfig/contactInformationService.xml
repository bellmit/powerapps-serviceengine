<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="contactInformationService">

<resultMap class="hmap" id="getCustomerAddress">
<result property="CONTACT_ID" javaType="long"/>
<result property="DISABLE" javaType="boolean"/>
<result property="NAME" javaType="string"/>
<result property="CONTACT_TYPE" javaType="string"/>
<result property="LINE_1" javaType="string"/>
<result property="LINE_2" javaType="string"/>
<result property="LINE_3" javaType="string"/>
<result property="LINE_4" javaType="string"/>
<result property="STATE" javaType="string"/>
<result property="AREA" javaType="string"/>
<result property="REMARKS" javaType="string"/>
<result property="RELATIONSHIP" javaType="string"/>
<result property="HOST_SEQUENCE" javaType="long"/>
<result property="SOURCE" javaType="string"/>
<result property="AGENCY_ADDED" javaType="boolean"/>
<result property="UPDATED_TIME" javaType="ts"/>
<result property="UPDATED_USER_ID" javaType="string"/>
<result property="EDITED_DATE" javaType="date"/>
<result property="VERIFIED_STATUS" javaType="string"/>
<result property="VERIFIED_DATE" javaType="date"/>
<result property="VERIFIED_BY" javaType="string"/>
<result property="USER_ID" javaType="string"/>
<result property="CITY" javaType="string"/>
<result property="COUNTRY" javaType="string"/>
<result property="POSTCODE" javaType="string"/>
<result property="ENABLE_EDIT_ADDRESS" javaType="boolean"/>
</resultMap>

<select id="getCustomerAddress" resultMap="getCustomerAddress">
select 
a.id, a.disable, a.contact_name, type.description, a.line_1,
a.line_2, a.line_3, a.line_4, state.description, null,
a.remarks, null, a.HOST_SEQUENCE, source.description, case when a.agency_id is not null then true else false end,
coalesce(a.updated_time,a.created_time), coalesce(a.updated_user_id,a.created_user_id),
a.updated_time,sr.description,a.verified_date,a.verified_by,null,a.city,co.description,
a.postcode, true as ENABLE_EDIT_ADDRESS
from ptraddress a
left join ptrtreatment_status_ref sr on sr.id=a.verified_status_id
left join ptraddress_type_ref type on type.id=a.address_type_id
left join ptrstate_ref state on state.id=a.state_id
left join ptrcontact_source_ref source on source.id=a.contact_source_id
left join ptrcountry_ref co on co.id=a.country_id
where a.customer_id=cast(#CUSTOMER_ID# as bigint)
union all
select 
a.id, a.disable, c.customer_name, type.description, a.line_1,
a.line_2, a.line_3, a.line_4, state.description, null,
'' remarks, null, a.SEQUENCE, 'host' as source, false as is_agency_added,
x.execution_time as updated_time, '' as updated_user,
null as updated_time,'' as treatment_status,null as verified_date,'' as verified_by,null,a.city,co.description,
a.postal_code, false as ENABLE_EDIT_ADDRESS
from ptrhost_address a
inner join ptrcustomer c on a.customer_id = c.id
left join ptrhost_address_type_ref type on type.id=a.host_address_type_id
left join ptrstate_ref state on state.id=a.state_id
left join ptrcountry_ref co on co.id=a.country_id
left join ptrload_execution x on a.load_execution_id = x.id
where a.customer_id=cast(#CUSTOMER_ID# as bigint)
</select>

<resultMap class="hmap" id="getCustomerContactNumber">
<result property="CONTACT_ID" javaType="long"/>
<result property="DISABLE" javaType="boolean"/>
<result property="NAME" javaType="string"/>
<result property="ENTITY" javaType="string"/>
<result property="CONTACT_TYPE" javaType="string"/>
<result property="CONTACT_NUMBER" javaType="string"/>
<result property="REMARKS" javaType="string"/>
<result property="RELATIONSHIP" javaType="string"/>
<result property="CONTACT_RELATIONSHIP" javaType="string"/>
<result property="SMS_TAG" javaType="boolean"/>
<result property="HOST_SEQUENCE" javaType="long"/>
<result property="SOURCE" javaType="string"/>
<result property="AGENCY_ADDED" javaType="boolean"/>
<result property="UPDATED_TIME" javaType="ts"/>
<result property="UPDATED_USER_ID" javaType="string"/>
<result property="REACTIVATED_TIME" javaType="ts"/>
<result property="REACTIVATED_BY" javaType="string"/>
<result property="EXCLUDE_EXTRACTION" javaType="boolean"/>
<result property="HOST_SEQUENCE" javaType="long"/>
<result property="VERIFIED_STATUS" javaType="string"/>
<result property="VERIFIED_DATE" javaType="date"/>
<result property="VERIFIED_BY" javaType="string"/>
<result property="IS_EXCLUDE_EXTRACTION" javaType="boolean"/>
<result property="ENABLE_EDIT_CONTACT" javaType="boolean"/>
<result property="ENABLE_DISABLE_CONTACT" javaType="boolean"/>
<result property="CONTACT_SOURCE_ID" javaType="long"/>
</resultMap>

<select id="getCustomerContactNumber" resultMap="getCustomerContactNumber">
select 
a.id, a.disable, a.contact_name, null, type.description, 
a.no, a.remarks, a.relationship, null, a.is_preferred_sms,
null, source.description, case when a.agency_id is not null then true else false end, coalesce(a.updated_time,a.created_time), coalesce(a.updated_user_id,a.created_user_id),
a.reactivated_time, a.reactivated_by, coalesce(a.is_exclude_extraction,false), a.host_sequence,
sr.description,a.verified_date,a.verified_by,a.is_exclude_extraction, 
true as ENABLE_EDIT_CONTACT,
true as ENABLE_DISABLE_CONTACT,
a.CONTACT_SOURCE_ID
from ptrcontact_number a
left join ptrtreatment_status_ref sr on sr.id=a.verified_status_id
left join ptrcontact_number_type_ref type on type.id=a.contact_type_id
left join ptrcontact_source_ref source on source.id=a.contact_source_id
where a.customer_id=cast(#CUSTOMER_ID# as bigint)
union all
select 
a.id, a.disable, a.contact_name, null, type.description, 
a.no, '' as remarks, null as relationship, null, coalesce(null,false) as is_preferred_sms,
null,'host' as source, false as is_from_agency, x.execution_time created_time, '' created_user,
null as reactivated_time, '' as reactivated_by, false as is_exclude_extraction, a.SEQUENCE,
null,null as verified_date,'' as verified_by, false as is_exclude_extraction, 
true as ENABLE_EDIT_CONTACT,
false as ENABLE_DISABLE_CONTACT,
null as CONTACT_SOURCE_ID
from ptrhost_phone_no a
left join ptrcustomer cus on a.customer_id = cus.id
left join ptrphone_type_ref type on type.id=a.host_phone_no_type_id
left join ptrload_execution x on a.load_execution_id = x.id
where a.customer_id=cast(#CUSTOMER_ID# as bigint)
</select>


<select id="getContactAddressTypeRef" resultMap="global.ref">
<include refid="pleaseSelectRef"/>
union
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY from PTRADDRESS_TYPE_REF where disable = false
</select>
<select id="getContactNumberTypeRef" resultMap="global.ref">
<include refid="pleaseSelectRef"/>
union
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY from PTRCONTACT_NUMBER_TYPE_REF where disable = false
</select>

<select id="getContactNumberTypeRefHost" resultMap="global.ref">
<include refid="pleaseSelectRef"/>
union
select 4,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY from ptrhost_phone_no_type_ref where disable = false
</select>

<select id="getContactRelationshipTypeRef" resultMap="global.ref">
<include refid="pleaseSelectRef"/>
union
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY from ptrcustomer_account_relation_type_ref where disable = false
</select>

<resultMap class="hmap" id="getContactStateRef" extends="global.ref">
<result property="COUNTRY_ID" javaType="long"/>
</resultMap>

<select id="getContactStateRef" resultMap="getContactStateRef">
<include refid="pleaseSelectRef"/>, NULL as COUNTRY_ID <include refid="fromdual"/>
union
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY,COUNTRY_ID from PTRSTATE_REF where disable = false
</select>
<select id="getContactCountryRef" resultMap="getContactStateRef">
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY,ID from PTRCOUNTRY_REF where disable = false
</select>
<select id="getContactVerifiedStatus" resultMap="global.ref">
<include refid="pleaseSelectRef"/> <include refid="fromdual"/>
union
select id, code, description, disable, sort_priority from ptrtreatment_status_ref where id in (15001,15004)
</select>


<resultMap class="hmap" id="getContactAddressEdit">
<result property="CONTACT_ID" javaType="long"/>
<result property="DISABLE" javaType="boolean"/>
<result property="CONTACT_NAME" javaType="string"/>
<result property="TYPE_ID" javaType="long"/>
<result property="LINE_1" javaType="string"/>

<result property="LINE_2" javaType="string"/>
<result property="LINE_3" javaType="string"/>
<result property="LINE_4" javaType="string"/>
<result property="STATE_ID" javaType="long"/>
<result property="CITY" javaType="string"/>

<result property="REMARKS" javaType="string"/>
<result property="COUNTRY_ID" javaType="long"/>
<result property="POSTCODE" javaType="string"/>
<result property="AGENCY_ADDED" javaType="boolean"/>
<result property="VERIFIED_STATUS_ID" javaType="long"/>
</resultMap>

<select id="getContactAddressEdit" resultMap="getContactAddressEdit">
select ID, DISABLE, CONTACT_NAME, ADDRESS_TYPE_ID, LINE_1,
LINE_2, LINE_3, LINE_4, STATE_ID, CITY,
REMARKS, COUNTRY_ID, POSTCODE, CASE WHEN AGENCY_ID IS NOT NULL THEN TRUE ELSE FALSE END,
VERIFIED_STATUS_ID from PTRADDRESS where ID=#CONTACT_ID#
</select>



<insert id="insertAddress" parameterClass="map">
<selectKey keyProperty="ID" resultClass="long">
<include refid="sequencePrefix" />PTRADDRESS_ID<include refid="sequenceSuffix" />
</selectKey>
insert into PTRADDRESS 
(ID,CUSTOMER_ID,CONTACT_NAME,LINE_1,LINE_2,
LINE_3,LINE_4,POSTCODE,CITY,STATE_ID,COUNTRY_ID,
ADDRESS_TYPE_ID,AGENCY_ID,REMARKS,CREATED_USER_ID,CREATED_TIME,
DISABLE,CONTACT_SOURCE_ID)
values
(#ID#,cast(#CUSTOMER_ID# as bigint),#CONTACT_NAME#,#LINE_1#,#LINE_2#,
#LINE_3#,#LINE_4#,#POSTCODE#,#CITY#,#STATE_ID#,#COUNTRY_ID#,
#TYPE_ID#,#AGENCY_ID#,#REMARKS#,#LOGON_USER#,#CURRENT_DATE#,
coalesce(#DISABLE#,false),#CONTACT_SOURCE_ID#)
</insert>

<update id="updateAddress" parameterClass="map">
update PTRADDRESS set
CONTACT_NAME=#CONTACT_NAME#,LINE_1=#LINE_1#,LINE_2=#LINE_2#,LINE_3=#LINE_3#,LINE_4=#LINE_4#,
POSTCODE=#POSTCODE#,CITY=#CITY#,STATE_ID=#STATE_ID#,COUNTRY_ID=#COUNTRY_ID#,ADDRESS_TYPE_ID=#TYPE_ID#,
AGENCY_ID=#AGENCY_ID#,REMARKS=#REMARKS#,DISABLE=#DISABLE#,UPDATED_USER_ID=#LOGON_USER#,UPDATED_TIME=#CURRENT_DATE#
where ID=#CONTACT_ID#
</update>

<update id="disableAddress" parameterClass="map">
update PTRADDRESS set DISABLE=true,UPDATED_USER_ID=#LOGON_USER#,UPDATED_TIME=#CURRENT_DATE#
where ID=#CONTACT_ID#
</update>

<update id="updateContactAddressVerifiedStatus" parameterClass="map">
update PTRADDRESS set VERIFIED_STATUS_ID=#VERIFIED_STATUS_ID#, VERIFIED_DATE=#CURRENT_DATE#, VERIFIED_BY=#LOGON_USER# 
where ID=#CONTACT_ID#
</update>
<update id="updateContactNumberVerifiedStatus" parameterClass="map">
update PTRCONTACT_NUMBER set VERIFIED_STATUS_ID=#VERIFIED_STATUS_ID#, VERIFIED_DATE=#CURRENT_DATE#, VERIFIED_BY=#LOGON_USER# 
where ID=#CONTACT_ID#
</update>

<resultMap class="hmap" id="getContactSourcePowerCollect">
<result property="CONTACT_SOURCE_ID" javaType="long"/>
</resultMap>
<select id="getContactSourcePowerCollect" resultMap="getContactSourcePowerCollect">
select ID from ptrcontact_source_ref where description='PowerCollect'
</select>

<resultMap class="hmap" id="getContactCurrentVerifiedStatus">
<result property="IS_CURRENT_VERIFIED_STATUS" javaType="boolean"/>
</resultMap>
<select id="getContactAddressCurrentVerifiedStatus" resultMap="getContactCurrentVerifiedStatus">
select case when VERIFIED_STATUS_ID=#VERIFIED_STATUS_ID# then true else false end from PTRADDRESS where ID=#CONTACT_ID#
</select>
<select id="getContactNumberCurrentVerifiedStatus" resultMap="getContactCurrentVerifiedStatus">
select case when VERIFIED_STATUS_ID=#VERIFIED_STATUS_ID# then true else false end from PTRCONTACT_NUMBER where ID=#CONTACT_ID#
</select>

<resultMap class="hmap" id="getContactIsReactivated">
<result property="IS_REACTIVATED" javaType="boolean"/>
</resultMap>
<select id="getContactNumberIsReactivated" resultMap="getContactIsReactivated">
select case when DISABLE=true and #DISABLE#=false then true else false end from PTRCONTACT_NUMBER where ID=#CONTACT_ID#
</select>


<resultMap class="hmap" id="getContactNumberEdit">
<result property="CONTACT_ID" javaType="long"/>
<result property="DISABLE" javaType="boolean"/>
<result property="CONTACT_NAME" javaType="string"/>
<result property="TYPE_ID" javaType="long"/>
<result property="CONTACT_NO" javaType="string"/>
<result property="RELATIONSHIP" javaType="string"/>
<result property="REMARKS" javaType="string"/>
<result property="AGENCY_ADDED" javaType="boolean"/>
<result property="VERIFIED_STATUS_ID" javaType="long"/>
<result property="IS_HOST" javaType="boolean"/>
<result property="IS_PREFERRED_SMS" javaType="boolean"/>
<result property="IS_EXCLUDE_EXTRACTION" javaType="boolean"/>
<result property="CONTACT_SOURCE_ID" javaType="long"/>
<result property="SOURCE" javaType="string"/>
</resultMap>

<select id="getContactNumberEdit" resultMap="getContactNumberEdit">
select c.ID, c.DISABLE, c.CONTACT_NAME, c.contact_type_id, c.NO,c.RELATIONSHIP,
c.REMARKS, CASE WHEN c.AGENCY_ID IS NOT NULL THEN TRUE ELSE FALSE END,
c.VERIFIED_STATUS_ID, CASE WHEN c.CONTACT_SOURCE_ID IS NULL THEN TRUE ELSE FALSE END,
c.IS_PREFERRED_SMS,c.IS_EXCLUDE_EXTRACTION,c.CONTACT_SOURCE_ID,s.DESCRIPTION as SOURCE
from PTRCONTACT_NUMBER c
left join ptrcontact_source_ref s on s.id=c.CONTACT_SOURCE_ID 
where c.ID=#CONTACT_ID#
</select>


<select id="getContactNumberEditHost" resultMap="getContactNumberEdit">
select
con.id,
con.disable,
c.customer_name,
con.host_phone_no_type_id,
con.no,
null as relationship,
null as remarks,
false as AGENCY_ADDED,
null as VERIFIED_STATUS_ID,
true as IS_HOST,
false as IS_PREFERRED_SMS,
false as IS_EXCLUDE_EXTRACTION,
null as CONTACT_SOURCE_ID,
null as SOURCE
from 

ptrcustomer c
inner join  ptrhost_phone_no con on c.id = con.customer_id
where con.ID=#CONTACT_ID#
</select>

<insert id="insertContactNumber" parameterClass="map">
<selectKey keyProperty="ID" resultClass="long">
<include refid="sequencePrefix" />PTRCONTACT_NUMBER_ID<include refid="sequenceSuffix" />
</selectKey>
insert into PTRCONTACT_NUMBER 
(ID,CUSTOMER_ID,CONTACT_NAME,NO,CONTACT_TYPE_ID,AGENCY_ID,REMARKS,CREATED_USER_ID,CREATED_TIME,
DISABLE,CONTACT_SOURCE_ID,IS_PREFERRED_SMS,IS_EXCLUDE_EXTRACTION,RELATIONSHIP)
values
(#ID#,cast(#CUSTOMER_ID# as bigint),#CONTACT_NAME#,#CONTACT_NO#,#TYPE_ID#,#AGENCY_ID#,#REMARKS#,#LOGON_USER#,#CURRENT_DATE#,
coalesce(#DISABLE#,false),#CONTACT_SOURCE_ID#,coalesce(#IS_PREFERRED_SMS#,false),coalesce(#IS_EXCLUDE_EXTRACTION#,false),#RELATIONSHIP#)
</insert>

<update id="updateContactNumber" parameterClass="map">
update PTRCONTACT_NUMBER set CUSTOMER_ID=cast(#CUSTOMER_ID# as bigint),CONTACT_NAME=#CONTACT_NAME#,NO=#CONTACT_NO#,CONTACT_TYPE_ID=#TYPE_ID#,
AGENCY_ID=#AGENCY_ID#,REMARKS=#REMARKS#,UPDATED_USER_ID=#LOGON_USER#,UPDATED_TIME=#CURRENT_DATE#,DISABLE=#DISABLE#,
CONTACT_SOURCE_ID=#CONTACT_SOURCE_ID#,IS_PREFERRED_SMS=#IS_PREFERRED_SMS#,IS_EXCLUDE_EXTRACTION=coalesce(#IS_EXCLUDE_EXTRACTION#,false),
RELATIONSHIP=#RELATIONSHIP#
where ID=#CONTACT_ID#
</update>

<update id="updateContactNumberHost" parameterClass="map">
update ptrhost_phone_no 
set
disable  = #DISABLE#
where id = #CONTACT_ID#
</update>



<update id="updateContactNumberIsReactivated" parameterClass="map">
update PTRCONTACT_NUMBER set reactivated_time=#CURRENT_DATE#, reactivated_by=#LOGON_USER# where ID=#CONTACT_ID#
</update>

<update id="disableContactNumber" parameterClass="map">
update PTRCONTACT_NUMBER set DISABLE=true,UPDATED_USER_ID=#LOGON_USER#,UPDATED_TIME=#CURRENT_DATE#
where ID=#CONTACT_ID#
</update>

<update id="refreshSearchContactNumber" parameterClass="map">
refresh materialized view ptrsearch_contact_number
</update>
<update id="refreshSearchAddress" parameterClass="map">
refresh materialized view ptrsearch_address
</update>

</sqlMap>