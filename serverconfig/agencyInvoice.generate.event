<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<event transactional="false" type="event">
   <exec ceiling="false" endmonth="false" nextweekday="false" startmonth="false"
         truncate="false"
         type="date"/>
   <exec type="guard">
      <conditions>
         <condition lhsfield="ECA_BILLING_ID" operator="not present" rhsvalue=""/>
      </conditions>
      <exec ceiling="false" endmonth="false" nextweekday="false" startmonth="false"
            to="GENERATED_TIME"
            truncate="false"
            type="date"/>
      <exec statement="insertEcaInvoice" type="insert"/>
      <exec from="ID" to="ECA_BILLING_ID" type="copy"/>
   </exec>
   <exec type="guard">
      <conditions>
         <condition lhsfield="IS_ISLAMIC" operator="=" rhsvalue="true"/>
      </conditions>
      <exec statement="insertAgencyGeneratedInvoiceCommissionLinkIslamic" type="insert"/>
   </exec>
   <exec type="guard">
      <conditions>
         <condition lhsfield="IS_ISLAMIC" operator="=" rhsvalue="false"/>
      </conditions>
      <exec statement="insertAgencyGeneratedInvoiceCommissionLink" type="insert"/>
   </exec>
   <exec recordcount="" statement="updateInvoiceLastNumberOnInvoiceGenerationCompletion"
         type="update"/>
   <exec argument="CONTRACT_LIST" query="getContractsWithGeneratedInvoiceTransactions"
         type="query"/>
   <exec from="ECA_BILLING_ID" key="ECA_BILLING_ID" to="CONTRACT_LIST"
         type="copyintolist"/>
   <exec from="CURRENT_DATE" key="CURRENT_DATE" to="CONTRACT_LIST" type="copyintolist"/>
   <exec argument="CONTRACT_LIST" type="loop">
      <exec statement="getEcaBillingInvoiceStartingNumber" type="select"/>
      <exec statement="getEcaBillingInvoiceNoLength" type="select"/>
      <exec message="{0}{1}" target="TAX_INVOICE_NO" type="formattext">
         <key value="PREFIX"/>
         <key value="INVOICE_NO"/>
      </exec>
      <exec type="guard">
         <conditions>
            <condition lhsfield="INVOICE_NO_LENGTH_IS_LOWER_THAN_FIVE" operator="=" rhsvalue="true"/>
         </conditions>
         <exec message="0000{0}" target="INVOICE_NO_TEXT" type="formattext">
            <key value="INVOICE_NO"/>
         </exec>
         <exec from="INVOICE_NO_TEXT" regex=".*(.{5})" replacement="$1" to="INVOICE_NO_TEXT"
               type="regexreplace"/>
         <exec message="{0}{1}" target="TAX_INVOICE_NO" type="formattext">
            <key value="PREFIX"/>
            <key value="INVOICE_NO_TEXT"/>
         </exec>
      </exec>
      <exec recordcount="" statement="updateEcaInvoiceNo" type="update"/>
      <exec statement="insertEcaBiilingHistoryByBatch" type="insert"/>
      <exec recordcount="" statement="updateAgencyContractInvoiceTransactionSummary"
            type="update"/>
   </exec>
</event>