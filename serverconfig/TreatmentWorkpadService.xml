<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="treatmentWorkpadService">


<resultMap id="getTreatmentPermissions" class="hmap">
  <result property="PROCESS_TYPE_ID" javaType="long" />
  <result property="CREATE" javaType="boolean" />
  <result property="UPDATE" javaType="boolean" />
</resultMap>
<select id="getTreatmentPermissions" resultMap="getTreatmentPermissions" parameterClass="map">
  select 2, 1 as C, 1 as U <include refid="fromdual"/>
  union
  select 8, 1 as C, 1 as U <include refid="fromdual"/>
  union
  select 13, 1 as C, 1 as U <include refid="fromdual"/>
</select>

	<resultMap id="getTreatmentWorkpadAccount" class="hmap">
		<result property="ACCOUNT_ID" javaType="long" />
		<result property="ACCOUNT_NUMBER" javaType="string" />
		<result property="CUSTOMER_NAME" javaType="string" />
		<result property="CUSTOMER_ID" javaType="long" />
		<result property="LOAN_CATEGORY_PERMISSIONS" javaType="string" />
		
		<result property="CIF_NO" javaType="string"/>
		<result property="ACCOUNT_STATUS" javaType="string"/>
		<result property="ACCOUNT_STATUS_DATE" javaType=""/>
		<result property="PRODUCT_TYPE" javaType="string"/>
		<result property="OS_BALANCE" javaType="$"/>
		
		<result property="ACTIVITY_TODAY" javaType="string"/>
		<result property="MONTHLY_INSTALLMENT" javaType="$"/>
		<result property="MONTHLY_INTEREST" javaType="$"/>
		<result property="DIA" javaType="long"/>
		<result property="MIA" javaType="long"/>
		
		<result property="NPL_STATUS" javaType="string"/>
		<result property="NEXT_INT_PAYMENT_DUE_DATE" javaType="date"/>
		<result property="NEXT_PAYMENT_DUE_DATE" javaType="date"/>
		<result property="ADVANCE_PAYMENT" javaType="$"/>
		<result property="NO_OF_INST_DUE" javaType="long"/>
		
		<result property="TOTAL_INST_DUE" javaType="$"/>
		<result property="NO_OF_INTEREST_DUE" javaType="$"/>
		<result property="TOTAL_INTEREST_DUE" javaType="$"/>
		<result property="LATE_CHARGES" javaType="$"/>
		<result property="MISC_CHARGES" javaType="$"/>
		
		<result property="OTHER_CHARGES" javaType="$"/>
		<result property="TOTAL_DUE" javaType="$"/>
		<result property="SEC_ACT_INT" javaType="$"/>
		<result property="TOTAL_ARREARS" javaType="$"/>
		<result property="REGISTRATION_NUMBER" javaType="string"/>
		
		<result property="CASH_PRICE_RATIO" javaType="$"/>
		<result property="SHORTFALL_STATUS" javaType="string"/>
		<result property="COURT_ORDER_FLAG" javaType="string"/>
		<result property="TOTAL_OVERDUE" javaType="$"/>
		<result property="CB_FLAG_STATUS" javaType="string"/>
		
		<result property="INSTALLMENT_AMOUNT" javaType="$"/>
		<result property="AMT_PARTIALLY_PAID" javaType="$"/>
		<result property="SELF_CURE" javaType="string"/>
		<result property="MODEL" javaType="string" />
		<result property="IC_NO" javaType="string"/>
	</resultMap>

	<select id="getTreatmentWorkpadAccount" resultMap="getTreatmentWorkpadAccount"
		parameterClass="map">
		select
		A.ID,
		A.account_no,
		C.CUSTOMER_NAME,
		A.CUSTOMER_ID,
		PC.CODE,
		
		c.CUSTOMER_NO as CIF_NO,
		st.description as ACCOUNT_STATUS,
		a.status_date as ACCOUNT_STATUS_DATE,
		p.description as PRODUCT_TYPE,
		coalesce(a.CURRENT_BALANCE,0) as OS_BALANCE,
		
		NULL as ACTIVITY_TODAY,
		a.payment_amount as MONTHLY_INSTALLMENT,
		coalesce(NULL,0) as MONTHLY_INTEREST,
		coalesce(a.MONTHS_IN_ARREARS * 30,0) as DIA,
		coalesce(a.months_in_arrears,0) as MIA,
		
		npl.description as NPL_STATUS,
		a.NEXT_PAYMENT_DUE_DATE as NEXT_INT_PAYMENT_DUE_DATE,
		a.NEXT_PAYMENT_DUE_DATE,
		coalesce(a.ADVANCE_PAYMENT_AMOUNT,0) as ADVANCE_PAYMENT,
		coalesce(a.installment_amount_in_arrears,0) as NO_OF_INST_DUE,
		
		coalesce(a.interest_due_amount,0) as TOTAL_INST_DUE,
		coalesce(NULL,0) as NO_OF_INTEREST_DUE,
		coalesce(a.TOTAL_INTEREST_IN_SUSPENSE,0) as TOTAL_INTEREST_DUE,
		a.tawidh_amount as LATE_CHARGES,
		coalesce(a.miscellaneous_charge,0) as MISC_CHARGES,
		
		coalesce(a.other_charge,0) as OTHER_CHARGES,
		coalesce(a.total_amount_due,0) as TOTAL_DUE,
		coalesce(a.total_interest_in_suspense,0) as SEC_ACT_INT,
		a.total_amount_due as TOTAL_ARREARS,
		col.registration_no as REGISTRATION_NUMBER,
		
		coalesce(total_installment_paid_cash_price_ratio,0) as CASH_PRICE_RATIO,
		case when tlast.tlast_value_58 = #tlast.tlast_value_58# then 'Yes' else 'No' end as SHORTFALL_STATUS,
		NULL as COURT_ORDER_FLAG,
		coalesce(a.total_amount_due,0) as TOTAL_OVERDUE,
		NULL as CB_FLAG_STATUS,
		
		coalesce(a.PAYMENT_AMOUNT,0) as INSTALLMENT_AMOUNT,
		coalesce(a.partial_payment_amount,0) as AMT_PARTIALLY_PAID,
		sc.status as SELF_CURE,
		col.model_no as MODEL,
		c.customer_id_no as IC_NO
		
		FROM PTRACCOUNT A 
		INNER JOIN PTRCUSTOMER C ON A.CUSTOMER_ID=C.ID
		INNER JOIN PTRPRODUCT_TYPE_REF P ON A.PRODUCT_TYPE_ID=P.ID
		INNER JOIN PTRPRODUCT_TYPE_CATEGORY_REF PC ON P.CATEGORY_ID=PC.ID
		left join ptraccount_status_ref st on st.id=a.STATUS_ID
		left join ptrnpl_status_ref npl on npl.id=a.npl_status_id
		LEFT JOIN PTRACC_SELF_CURE_STATUS SC ON SC.ACCOUNT_ID=A.ID
		left join (
         select r.account_id, c.registration_no, c.model_no 
         from ptraccount ac 
         inner join ptrcustomer cus on ac.customer_id = cus.id 
         inner join ptraccount_collateral_rel r on ac.id = r.account_id
         inner join ptrcollateral c on r.collateral_id = c.id and cus.customer_no = ltrim(registered_owner_cif_no, '0')
         where ac.id = #ACCOUNT_ID#
         )col on a.id = col.account_id
		left join ptraccount_tlast tlast on tlast.account_id=a.id
		WHERE A.ID = #ACCOUNT_ID:NUMERIC#
	</select>
	
	<resultMap class="hmap" id="getTreatmentWorkpadLinkedAccounts">
	<result property="ACCOUNT_NUMBER" javaType="string"/>
	<result property="PRODUCT_TYPE" javaType="string"/>
	<result property="ACCOUNT_STATUS" javaType="string" />
	</resultMap>
	
	<select id="getTreatmentWorkpadLinkedAccounts" resultMap="getTreatmentWorkpadLinkedAccounts">
	select 
		a.account_no,
		p.description as PRODUCT_TYPE,
		status.description as ACCOUNT_STATUS
		from ptraccount a
		INNER JOIN PTRPRODUCT_TYPE_REF P ON A.PRODUCT_TYPE_ID=P.ID
		INNER JOIN PTRPRODUCT_TYPE_CATEGORY_REF PC ON P.CATEGORY_ID=PC.ID
		LEFT JOIN PTRACCOUNT_STATUS_REF STATUS ON STATUS.ID=A.STATUS_ID
	where a.CUSTOMER_ID=#CUSTOMER_ID#
	</select>

	<resultMap id="getAccountTreatmentPlans" class="hmap">
		<result property="TREATMENT_PLAN_ID" javaType="long" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="START" javaType="long" />
		<result property="END" javaType="long" />
	</resultMap>
	<select id="getAccountTreatmentPlans" resultMap="getAccountTreatmentPlans">
		select 1, 'Actions taken in the last 30 days', 0, -30
		<include refid="fromdual" />
		union
		select 2, 'Actions taken 30 days to 90 days ago', -30, -90
		<include refid="fromdual" />
		union<!-- The NULL END is to tell the event to not stick an end date on -->
		select 3, 'Actions taken more than 90 days ago', -90, null
		<include refid="fromdual" />
	</select>

	<resultMap id="getPlanTreatments" class="hmap">
		<result property="ID" javaType="long" />
		<result property="TREATMENT_PROCESS_ID" javaType="long" />
		<result property="PROCESS_TYPE" javaType="string" />
		<result property="CREATED_TIME" javaType="date" />
		<result property="ACTUAL_START_DATE" javaType="date" />
		<result property="PROCESS_TYPE_ID" javaType="long" />
		<result property="PROCESS_STATUS_ID" javaType="long" />
		<result property="IS_OPEN" javaType="boolean" />
		<result property="PROCESS_STATUS" javaType="string" />
	</resultMap>
	<select id="getPlanTreatments" resultMap="getPlanTreatments">
		select t.ID, t.ID, tt.DESCRIPTION, t.CREATED_TIME,
		t.CREATED_TIME as
		ACTUAL_START_DATE,
		t.TYPE_ID, t.STATUS_ID, 0, s.DESCRIPTION
		from
		PTRTREATMENT t
		inner join ptrtreatment_type_ref tt on tt.ID = t.TYPE_ID
		inner join ptrtreatment_status_ref s on s.ID=t.STATUS_ID
		where
		t.ACCOUNT_ID = #ACCOUNT_ID#
		and cast(#START_DATE:TIMESTAMP# as DATE) >= date(t.created_time)
		<isNotNull property="END_DATE">
			and date(t.created_time) > cast(#END_DATE:TIMESTAMP# as DATE)
		</isNotNull>
		<isEqual property="USER_TYPE_ID" compareValue="2">
		and t.AGENCY_ID=#AGENCY_ID#
		</isEqual>
		order by CREATED_TIME
	</select>
	<resultMap id="getTreatmentStatus" class="hmap">
		<result property="STATUS_ID" />
	</resultMap>
	<select id="getSuccessfulTreatmentStatus" resultMap="getTreatmentStatus">
		select 15004
		<include refid="fromdual" />
	</select>
	<resultMap id="genericList" class="hmap">
		<result property="ID" />
		<result property="CODE" />
		<result property="DESCRIPTION" />
		<result property="SORT_PRIORITY" />
	</resultMap>
	<select id="genericList" resultMap="genericList">
		select null,' ' ,' Please Select', 1	<include refid="fromdual" /> union
		select false,'NO' ,'No', 2	<include refid="fromdual" /> union
		select true,'YES' ,'Yes', 3	<include refid="fromdual" />
	</select>	
	<select id="genericAllList" resultMap="genericList">
		select null,' ' ,'All', 1	<include refid="fromdual" /> union
		select false,'NO' ,'No', 2	<include refid="fromdual" /> union
		select true,'YES' ,'Yes', 3	<include refid="fromdual" />
	</select>	
	<resultMap class="hmap" id="getDefaultTreatmentStatusType" extends="global.ref">
		<result property="STATUS_ID" javaType="long"/>
	</resultMap>	
	<select id="getDefaultTreatmentStatusType" resultMap="getDefaultTreatmentStatusType">
	select ID, CODE, DESCRIPTION, DISABLE, SORT_PRIORITY,STATUS_ID from PTRTREATMENT_TYPE_STATUS_REF 
	where TYPE_ID=#PROCESS_TYPE_ID#
	order by UPPER(DESCRIPTION)
	</select>
	<select id="getDefaultTreatmentSubType" resultMap="global.ref">
	select ID, CODE, DESCRIPTION, DISABLE, SORT_PRIORITY from PTRTREATMENT_SUBTYPE_REF 
	where TYPE_ID=#PROCESS_TYPE_ID#
	order by UPPER(DESCRIPTION)
	</select>
	<select id="getDefaultTreatmentSubTypeAccountTagging" resultMap="global.ref">
	select ID, CODE, DESCRIPTION, DISABLE, SORT_PRIORITY from PTRTREATMENT_SUBTYPE_REF 
	where TYPE_ID = 56
	order by UPPER(DESCRIPTION)
	</select>	
	<resultMap id="getTreatmentForEditing" class="hmap">
		<result property="ID" javaType="long" />
		<result property="ACCOUNT_ID" javaType="long" />
		<result property="TREATMENT_PROCESS_ID" javaType="long" />
		<result property="PROCESS_TYPE" javaType="string" />
		<result property="CREATED_TIME" javaType="ts" />
		<result property="UPDATED_TIME" javaType="ts" />
		<result property="PROCESS_TYPE_ID" javaType="long" />
		<result property="TYPE_ID" javaType="long" />
		<result property="PROCESS_STATUS_ID" javaType="long" />
		<result property="IS_OPEN" javaType="boolean" />
		<result property="NOTE_TEXT" javaType="string" />
		<result property="ACCOUNT_NUMBER" javaType="string" />
		<result property="SOURCE" javaType="string" />
		<result property="TRUE" javaType="boolean" />
		<result property="FALSE" javaType="boolean" />
		<result property="CREATED_USER_ID" javaType="string"/>
		<result property="TREATMENT_SOURCE_ID" javaType="long"/>
		<result property="CUSTOMER_ID" javaType="long"/>
		<result property="TYPE_STATUS_ID" javaType="long"/>
	</resultMap>
	<select id="getTreatmentForEditing" resultMap="getTreatmentForEditing">
		SELECT T.ID, A.ID, T.ID AS LEGACY_TREATMENT_PROCESS_ID, TT.DESCRIPTION,
		T.CREATED_TIME, T.UPDATED_TIME, T.TYPE_ID, T.TYPE_ID, T.STATUS_ID, 0
		AS IS_OPEN, N.NOTE_TEXT,
		A.ACCOUNT_NO, S.DESCRIPTION, <include refid="true"/>, <include refid="false"/>,
		t.CREATED_USER_ID, t.TREATMENT_SOURCE_ID, a.CUSTOMER_ID,T.type_status_id
		FROM PTRTREATMENT T
		INNER JOIN PTRACCOUNT A ON A.ID = T.ACCOUNT_ID
		INNER JOIN PTRTREATMENT_TYPE_REF TT ON TT.ID = T.TYPE_ID
		INNER JOIN PTRTREATMENT_SOURCE_REF S ON S.ID=T.TREATMENT_SOURCE_ID
		LEFT OUTER JOIN PTRTREATMENT_NOTE N ON N.TREATMENT_ID = T.ID
		where t.ID = #ID#
	</select>
	<insert id="insertTreatment">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRTREATMENT_ID
			<include refid="sequenceSuffix" />
		</selectKey>
		insert into PTRTREATMENT
		(ID, ACCOUNT_ID, CREATED_TIME, UPDATED_TIME,
		TYPE_ID, STATUS_ID,
		CREATED_USER_ID,
		UPDATED_USER_ID,AGENCY_ASSIGNMENT_ID,AGENCY_ID,TREATMENT_SOURCE_ID,TEMPLATE_ID,SUBTYPE_ID,TYPE_STATUS_ID)
		values
		(#ID#, #ACCOUNT_ID#, #CREATED_TIME#, #UPDATED_TIME#, #TYPE_ID#,
		#STATUS_ID#,
		#CREATED_USER_ID#, #UPDATED_USER_ID#, #AGENCY_ASSIGNMENT_ID#,
		CAST(#AGENCY_ID# AS BIGINT),cast(#TREATMENT_SOURCE_ID# as BIGINT),#TEMPLATE_ID#,#SUBTYPE_ID#,#TYPE_STATUS_ID#)
	</insert>
	<update id="updateTreatment">
		update PTRTREATMENT set
		ACCOUNT_ID = #ACCOUNT_ID#,
		UPDATED_TIME = #UPDATED_TIME#,
		TYPE_ID = #TYPE_ID#,
		STATUS_ID =#STATUS_ID#,
		UPDATED_USER_ID = #UPDATED_USER_ID#,
		TEMPLATE_ID = #TEMPLATE_ID#,
		TYPE_STATUS_ID = #TYPE_STATUS_ID#,
		SUBTYPE_ID = #SUBTYPE_ID#
		where
		ID = #ID#
	</update>
	<insert id="insertCurrentTreatment">
		INSERT INTO PTRACCOUNT_TREATMENT_CURRENT(ACCOUNT_ID,TREATMENT_ID,TYPE_ID,STATUS_ID,CREATED_TIME)
		VALUES(#ACCOUNT_ID#,#ID#,#TYPE_ID#,#STATUS_ID#,#CREATED_TIME#)
	</insert>
	<update id="updateCurrentTreatment">
		UPDATE PTRACCOUNT_TREATMENT_CURRENT SET STATUS_ID=#STATUS_ID# WHERE TREATMENT_ID=#ID#
	</update>
	<insert id="insertTreatmentNote">
		insert into PTRTREATMENT_NOTE
		(TREATMENT_ID,
		NOTE_TEXT)
		values
		(#ID#, #NOTE_TEXT#)
	</insert>
	<delete id="deleteTreatmentNote">
		delete from PTRTREATMENT_NOTE
		where TREATMENT_ID =
		#ID#
	</delete>
	<update id="updateAccountLastTreatment">
		UPDATE PTRACCOUNT_LAST_TREATMENT SET TREATMENT_ID = #ID#
		WHERE ACCOUNT_ID = #ACCOUNT_ID#
	</update>
	<insert id="insertAccountLastTreatment">
		INSERT INTO PTRACCOUNT_LAST_TREATMENT (TREATMENT_ID,ACCOUNT_ID)
		VALUES(#ID#,#ACCOUNT_ID#)
	</insert>
	<insert id="insertTreatmentHistory">
		<selectKey keyProperty="PTRTREATMENT_HISTORY_ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRTREATMENT_HISTORY_ID
			<include refid="sequenceSuffix" />
		</selectKey>
		insert into PTRTREATMENT_HISTORY
		(ID, TREATMENT_ID, ACCOUNT_ID, CREATED_TIME, UPDATED_TIME,
		TYPE_ID, STATUS_ID,
		CREATED_USER_ID,
		UPDATED_USER_ID,AGENCY_ASSIGNMENT_ID,AGENCY_ID,TREATMENT_SOURCE_ID)
		values
		(#PTRTREATMENT_HISTORY_ID# , #ID#, #ACCOUNT_ID#, #CREATED_TIME#, #UPDATED_TIME#, #TYPE_ID#,
		#STATUS_ID#,
		#CREATED_USER_ID#, #UPDATED_USER_ID#, #ASSIGNMENT_ID#,
		CAST(#ASSIGNMENT_AGENCY_ID# AS BIGINT),cast(#TREATMENT_SOURCE_ID# as BIGINT))
	</insert>
	
<resultMap id="getTreatmentSummary" class="hmap">
		<result property="CREATED_TIME" javaType="string" />
		<result property="UPDATED_TIME" javaType="string" />
		<result property="CREATED_USER_ID" javaType="string" />
		<result property="UPDATED_USER_ID" javaType="string" />
	</resultMap>

	<select id="getTreatmentSummary" resultMap="getTreatmentSummary"
		parameterClass="map">
select
to_char(CREATED_TIME,'dd-Mon-yyyy')||' @ '||to_char(CREATED_TIME,'HH12:MI A.M.') , 
case when CREATED_TIME=UPDATED_TIME then NULL else to_char(UPDATED_TIME,'dd-Mon-yyyy')||' @ '||to_char(UPDATED_TIME,'HH12:MI A.M.') end, 
CREATED_USER_ID, 
case when CREATED_TIME=UPDATED_TIME then NULL else UPDATED_USER_ID end
from ptrtreatment where ID=#ID#
	</select>
	
	<resultMap id="getTreatmentSummaryHistory" class="hmap">
	<result property="UPDATED_DATE" javaType="ts" />
		<result property="UPDATED_TIME" javaType="ts" />
		<result property="UPDATED_USER_ID" javaType="string" />
	</resultMap>

	<select id="getTreatmentSummaryHistory" resultMap="getTreatmentSummaryHistory"
		parameterClass="map">
select UPDATED_TIME, UPDATED_TIME, UPDATED_USER_ID from PTRTREATMENT_HISTORY where TREATMENT_ID=#ID# order by ID desc
	</select>
	
	<resultMap id="getTreatmentWorkpadHolidays-map" class="hmap">
		<result property="HOLIDAY_DATE" javaType="date" />
		<result property="HOLIDAY_STATE" />
	</resultMap>
	<select id="getTreatmentWorkpadHolidays" resultMap="getTreatmentWorkpadHolidays-map"> select
HOLIDAY_DATE,
s.description as HOLIDAY_STATE 
from ptrholiday h, ptrholiday_state_rel r, ptrstate_ref s 
where s.id = r.state_id and h.id = r.holiday_id and
holiday_date > current_timestamp - interval '1' day
	</select>
	
		<resultMap class="hmap" id="getTreatmentSubtypeNotPresent">
	<result property="SUBTYPE_ID" javaType="long"/>
	</resultMap>
	
	<select id="getTreatmentSubtypeNotPresent" resultMap="getTreatmentSubtypeNotPresent">
	select min(id) from ptrtreatment_subtype_ref where type_id=#PROCESS_TYPE_ID# and disable=false
	</select>
	
	<resultMap class="hmap" id="getTreatmentDefaultTypeStatus">
<result property="TYPE_STATUS_ID" javaType="long"/>
</resultMap>

<select id="getTreatmentDefaultTypeStatusPtp" resultMap="getTreatmentDefaultTypeStatus">
select ID from PTRTREATMENT_TYPE_STATUS_REF where TYPE_ID=#PROCESS_TYPE_ID# and CODE='PTP_INP'
</select>
<select id="getTreatmentDefaultTypeStatusLetter" resultMap="getTreatmentDefaultTypeStatus">
select ID from PTRTREATMENT_TYPE_STATUS_REF where TYPE_ID=#PROCESS_TYPE_ID# and CODE='LET_INP'
</select>
<select id="getTreatmentDefaultTypeStatusMeeting" resultMap="getTreatmentDefaultTypeStatus">
select ID from PTRTREATMENT_TYPE_STATUS_REF where TYPE_ID=#PROCESS_TYPE_ID# and CODE='MET_PEN'
</select>
<select id="getTreatmentDefaultTypeStatusTps" resultMap="getTreatmentDefaultTypeStatus">
select ID from PTRTREATMENT_TYPE_STATUS_REF where TYPE_ID=#PROCESS_TYPE_ID# and CODE='TPS_IPR'
</select>
<select id="getTreatmentDefaultTypeStatusPdc" resultMap="getTreatmentDefaultTypeStatus">
select ID from PTRTREATMENT_TYPE_STATUS_REF where TYPE_ID=#PROCESS_TYPE_ID# and CODE='PDC_SUCT'
</select>

<select id="getTreatmentDefaultTypeStatusNotes" resultMap="getTreatmentDefaultTypeStatus">
select ID from PTRTREATMENT_TYPE_STATUS_REF where TYPE_ID=#PROCESS_TYPE_ID# and CODE='NOTE_SUC'
</select>




<resultMap class="hmap" id="getTemplateVersionDocumentId">
	 	<result property="DOCUMENT_ID" javaType="long"/>
	</resultMap>
	
	<select id="getTemplateVersionDocumentId" resultMap="getTemplateVersionDocumentId">
		SELECT tv.DOCUMENT_ID FROM PTRTEMPLATE_VERSION tv where ID = #TEMPLATE_VERSION_ID#
	</select>


<resultMap class="hmap" id="getTreatmentTemplate">
<result property="ID" javaType="long"/>
<result property="CODE" javaType="string"/>
<result property="DESCRIPTION" javaType="string"/>
<result property="TEMPLATE_ID" javaType="long"/>
<result property="DISABLE" javaType="boolean"/>
<result property="SORT_PRIORITY" javaType="long"/>
</resultMap>

<select id="getTreatmentTemplate" resultMap="getTreatmentTemplate">
select NULL as ID, NULL as CODE, 'Please Select' as NAME, NULL as TEMPLATE_ID, false as DISABLE, -1 as SORT_PRIORITY
union
select tv.ID, type.CODE, t.NAME, t.ID as TEMPLATE_ID, tv.DISABLE, 1 as SORT_PRIORITY
from PTRTEMPLATE t
inner join PTRTEMPLATE_TYPE_REF type on t.TEMPLATE_TYPE_ID = type.ID
inner join PTRTEMPLATE_VERSION tv on t.ID = tv.TEMPLATE_ID
inner join PTRPRODUCT_TYPE_CATEGORY_REF ptc on ptc.ID=t.PRODUCT_TYPE_CATEGORY_ID
inner join PTRPRODUCT_TYPE_REF pro on pro.category_id=ptc.ID
inner join PTRACCOUNT a on a.PRODUCT_TYPE_ID=pro.ID
where t.DISABLE = false and a.ID=#ACCOUNT_ID#
<isEqual property="PROCESS_TYPE_ID" compareValue="13">
and type.CODE='SMS'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="14">
and type.CODE='LETTER'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="28">
and type.CODE='CCRIS'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="32">
and type.CODE='EMAIL'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="34">
and type.CODE like 'TPS%'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="36">
and type.CODE='SHORTFALL'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="40">
and type.CODE='MANAGEMENT_APPROVAL'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="15">
and type.CODE='VISITATION'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="41">
and type.CODE='ESO'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="49">
and type.CODE='RNR'
</isEqual>
<isEqual property="PROCESS_TYPE_ID" compareValue="55">
and type.CODE='14DN'
</isEqual>
union
select v.ID, type.CODE, t.NAME, t.ID as TEMPLATE_ID, v.DISABLE, 1 as SORT_PRIORITY
from PTRTEMPLATE t
inner join PTRTEMPLATE_TYPE_REF type on t.TEMPLATE_TYPE_ID = type.ID
inner join PTRTEMPLATE_VERSION v on t.ID=v.TEMPLATE_ID
where v.ID=#TEMPLATE_VERSION_ID# and t.DISABLE=false
</select>
	

<update id="updateLastTreatmentAction" parameterClass="map">
		with to_be_upserted (account_id, treatment_id, type_id, subtype_id, type_status_id, status_id, created_time) as (
 values
            (#ACCOUNT_ID#,#ID#,#TYPE_ID#,cast(#SUBTYPE_ID# as bigint),cast(#TYPE_STATUS_ID# as bigint),#STATUS_ID#,cast(#CREATED_TIME# as timestamp))
    ),
    updated as (
        update
            ptrlast_treatment_action
        set
            treatment_id = to_be_upserted.treatment_id,
            type_id = to_be_upserted.type_id,
            subtype_id = to_be_upserted.subtype_id,
            type_status_id = to_be_upserted.type_status_id,
            status_id = to_be_upserted.status_id,
            created_time = to_be_upserted.created_time
        from
            to_be_upserted
        where
            ptrlast_treatment_action.account_id = to_be_upserted.account_id
        returning ptrlast_treatment_action.account_id
    )
insert into ptrlast_treatment_action
    select * from to_be_upserted
    where account_id not in (select account_id from updated);
	</update>

<resultMap class="hmap" id="getTreatmentAgencyAssignmentId">
<result property="AGENCY_ASSIGNMENT_ID" javaType="long"/>
</resultMap>

<select id="getTreatmentAgencyAssignmentId" resultMap="getTreatmentAgencyAssignmentId">
select ID from PTRACCOUNT_AGENCY_ASSIGNMENT where ACCOUNT_ID=#ACCOUNT_ID# and AGENCY_ID=#AGENCY_ID# and STATUS_ID=15007 and acknowledged_date is not null
</select>

<update id="updateAccountInformation" parameterClass="map">
update ptraccount_information set $COLUMN$=#CREATED_TIME# where account_id=#ACCOUNT_ID#
</update>
<insert id="insertAccountInformation" parameterClass="map">
insert into ptraccount_information (account_id, $COLUMN$)
values (#ACCOUNT_ID#, #CREATED_TIME#)
</insert>


</sqlMap>