<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="pacService">

<resultMap class="hmap" id="getTreatmentContactNumbers">
<result property="CONTACT_NO" javaType="string"/>
<result property="CONTACT_ID" javaType="long"/>
<result property="CONTACT_PERSON" javaType="string"/>
<result property="RELATIONSHIP" javaType="string"/>
<result property="PREFERENCE" javaType="long" />
<result property="REMARKS" javaType="string" />
<result property="DISABLE" javaType="boolean" />
<result property="TYPE" javaType="string"/>
<result property="SOURCE" javaType="string"/>
</resultMap>

<sql id="getTreatmentContactNumbers">
select a.NO, a.CONTACT_ID, a.CONTACT_PERSON,
a.RELATIONSHIP, a.PREFERENCE, a.REMARKS, a.DISABLE, a.TYPE, a.SOURCE
 from
(
select c.NO, c.ID as CONTACT_ID, c.CONTACT_NAME as CONTACT_PERSON, 
c.RELATIONSHIP as RELATIONSHIP, null as PREFERENCE, c.remarks as REMARKS, c.disable, ct.description as TYPE, ct.CODE,
source.DESCRIPTION as SOURCE
from PTRCONTACT_NUMBER c
inner join ptrcontact_number_type_ref ct on ct.ID=c.CONTACT_TYPE_ID
left join ptrcontact_source_ref source on source.id=c.contact_source_id
where c.CUSTOMER_ID = cast(#CUSTOMER_ID# as bigint)
union
select c.NO, c.ID as CONTACT_ID, cus.customer_name as CONTACT_PERSON, 
null as RELATIONSHIP, null as PREFERENCE, null as REMARKS, false as DISABLE, t.description as TYPE, t.CODE,
'host' as SOURCE
from ptrhost_phone_no c
inner join ptrcustomer cus on cus.id=c.customer_id
inner join ptrphone_type_ref t on t.id=c.host_phone_no_type_id
where c.CUSTOMER_ID = cast(#CUSTOMER_ID# as bigint)
)a
</sql>

<select id="getTreatmentCallContactNumbers" resultMap="getTreatmentContactNumbers">
<include refid="getTreatmentContactNumbers"/> where a.CODE not in ('EMAIL','EM')
</select>
<select id="getTreatmentSmsContactNumbers" resultMap="getTreatmentContactNumbers">
<include refid="getTreatmentContactNumbers"/> where a.CODE in ('MOBILE','HP')
</select>


	<select id="getTreatmentPacRightParty" resultMap="global.ref">		
	<include refid="pleaseSelectRef"/> union
	<include refid="refselect"/> FROM ptrright_party_contact_ref WHERE DISABLE = false
	</select>
	
	
	<select id="getTreatmentPacReasonOfDefault" resultMap="global.ref">	
	<include refid="pleaseSelectRef"/> union	
	<include refid="refselect"/> FROM ptrreason_of_default_ref
	</select>
	
	<resultMap class="hmap" id="getCallReason" extends="global.ref">
	<result property="TYPE_STATUS_ID" javaType="long"/>
	</resultMap>
	
	<select id="getCallReason" resultMap="getCallReason">
	<include refid="refselect"/>, type_status_id FROM ptrreason_of_call_ref WHERE DISABLE = false
	</select>
	
	<select id="getTreatmentPacRequestZakat" resultMap="global.ref">	
	<include refid="pleaseSelectRef"/> union	
	<include refid="refselect"/> FROM ptryes_no_ref WHERE DISABLE = false
	</select>


	<insert id="insertTreatmentPac">
		insert into PTRTREATMENT_PLACE_A_CALL
		(TREATMENT_ID,ACCOUNT_ID,TYPE_STATUS_ID,SUBTYPE_ID,APPOINTMENT_TIME,RELATIONSHIP_TYPE,CONTACT_NO,
		SPOKE_TO,RIGHT_PARTY_CONTACT_ID,IS_REACHABLE,CUSTOMER_ZAKAT_ID,REASON_DEFAULT_ID,
		CONTACT_ID,RELATIONSHIP_TYPE_ID, REASON_CALL_ID)
		values
		(#ID#, #ACCOUNT_ID#,#TYPE_STATUS_ID#,#SUBTYPE_ID#,#APPOINTMENT_TIME#,#RELATIONSHIP_TYPE#,#CONTACT_NO#,
		#CONTACT_PERSON#,#RIGHT_PARTY_CONTACT_ID#,#IS_REACHABLE#,#CUSTOMER_ZAKAT_ID#,#REASON_DEFAULT_ID#,
		#CONTACT_ID#,#RELATIONSHIP_TYPE_ID#, #REASON_CALL_ID#)
	</insert>
	<update id="updateTreatmentPac">
	update PTRTREATMENT_PLACE_A_CALL set TYPE_STATUS_ID=#TYPE_STATUS_ID#,
	SUBTYPE_ID = #SUBTYPE_ID#,APPOINTMENT_TIME=#APPOINTMENT_TIME#,RELATIONSHIP_TYPE=#RELATIONSHIP_TYPE#,
	CONTACT_NO=#CONTACT_NO#,SPOKE_TO=#CONTACT_PERSON#,RIGHT_PARTY_CONTACT_ID=#RIGHT_PARTY_CONTACT_ID#,IS_REACHABLE=#IS_REACHABLE#,CUSTOMER_ZAKAT_ID=#CUSTOMER_ZAKAT_ID#,
	REASON_DEFAULT_ID=#REASON_DEFAULT_ID#,CONTACT_ID=#CONTACT_ID#,RELATIONSHIP_TYPE_ID=#RELATIONSHIP_TYPE_ID#, 
	REASON_CALL_ID=#REASON_CALL_ID# where TREATMENT_ID=#ID#
	</update>

<resultMap id="getTreatmentPac" class="hmap">
<result property="TYPE_STATUS_ID" javaType="long" />
<result property="SUBTYPE_ID" javaType="long" />
<result property="APPOINTMENT_TIME" javaType="ts" />
<result property="RELATIONSHIP_TYPE" javaType="string" />
<result property="CONTACT_PERSON" javaType="string" />
<result property="RIGHT_PARTY_CONTACT_ID" javaType="long" />
<result property="IS_REACHABLE" javaType="long" />
<result property="CUSTOMER_ZAKAT_ID" javaType="long" />
<result property="REASON_DEFAULT_ID" javaType="long" />
<result property="CONTACT_ID" javaType="long"/>
<result property="RELATIONSHIP" javaType="string"/>
<result property="RELATIONSHIP_TYPE_ID" javaType="long"/>
<result property="INSTALLMENT_AMOUNT" javaType="$"/>
<result property="PTP_AMOUNT" javaType="$"/>
<result property="PTP_DATE" javaType="date"/>
<result property="PTP_PERSON" javaType="string"/>
<result property="REASON_CALL_ID" javaType="long"/>
</resultMap>  

<select id="getTreatmentPac" resultMap="getTreatmentPac">   
SELECT 
pac.TYPE_STATUS_ID,
pac.SUBTYPE_ID,
pac.APPOINTMENT_TIME,
pac.RELATIONSHIP_TYPE,
pac.SPOKE_TO,
pac.RIGHT_PARTY_CONTACT_ID,
pac.IS_REACHABLE,
pac.CUSTOMER_ZAKAT_ID,
pac.REASON_DEFAULT_ID,
pac.CONTACT_ID,
null as RELATIONSHIP,
pac.relationship_type_id,
ptp.INSTALLMENT_AMOUNT,
ptp.AMOUNT,
ptp.due_time,
ptp.PTP_PERSON,
pac.reason_call_id
FROM PTRTREATMENT_PLACE_A_CALL pac
left join PTRTREATMENT_PTP ptp on ptp.TREATMENT_ID=pac.PTP_TREATMENT_ID
WHERE pac.TREATMENT_ID = #ID#
</select>


<resultMap id="getTreatmentContactNumber" class="hmap">
<result property="CONTACT_NO" javaType="string" />
</resultMap>  

<select id="getTreatmentContactNumber" resultMap="getTreatmentContactNumber">   
select no from PTRCONTACT_NUMBER where id = #CONTACT_ID# and customer_id = #CUSTOMER_ID#
union 
select no from ptrhost_phone_no where id = #CONTACT_ID# and customer_id = #CUSTOMER_ID#
</select> 

<resultMap class="hmap" id="getTreatmentPacStatusType" extends="global.ref">
		<result property="STATUS_ID" javaType="long"/>
		<result property="SUBTYPE_ID" javaType="long"/>
	</resultMap>	
	<select id="getTreatmentPacStatusType" resultMap="getTreatmentPacStatusType">
	select ID, CODE, DESCRIPTION, DISABLE, SORT_PRIORITY,STATUS_ID,SUBTYPE_ID 
	from PTRTREATMENT_TYPE_STATUS_REF 
	where TYPE_ID=#PROCESS_TYPE_ID#
	order by UPPER(DESCRIPTION)
	</select>
  
    <select id="getTreatmentPacStatusType-cti" resultMap="getTreatmentPacStatusType">
  select ID, CODE, DESCRIPTION, DISABLE, SORT_PRIORITY,STATUS_ID,SUBTYPE_ID 
  from PTRTREATMENT_TYPE_STATUS_REF 
  where TYPE_ID=#PROCESS_TYPE_ID# and code &lt;&gt; 'PLACE_UNS_IPR'
  order by UPPER(DESCRIPTION)
  </select>
	
	<resultMap class="hmap" id="getTreatmentCallPtpTypeStatus">
	<result property="PROCESS_TYPE_ID" javaType="long"/>
	<result property="TYPE_STATUS_ID" javaType="long"/>
	<result property="STATUS_ID" javaType="long"/>
	</resultMap>

	<select id="getTreatmentCallPtpTypeStatus" resultMap="getTreatmentCallPtpTypeStatus">
	select type_id, id, status_id from ptrtreatment_type_status_ref where type_id=2 and status_id=15007
	</select>
	
	<update id="updateTreatmentCallPtp" parameterClass="map">
	update PTRTREATMENT_PLACE_A_CALL set PTP_TREATMENT_ID=#ID# where TREATMENT_ID=#CALL_TREATMENT_ID#
	</update>

</sqlMap>