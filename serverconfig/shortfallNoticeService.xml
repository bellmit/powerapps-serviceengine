<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="shortfallNoticeService">

 	<resultMap class="hmap" id="getOSAmount100PercentChecker">
		<result property="IS_ENABLED" javaType="long" /> 
	</resultMap>
	 
	<select id="getOSAmount100PercentChecker" resultMap="getOSAmount100PercentChecker">
		select case when #OS_AMOUNT# &gt; 100 then 1 
					when #OS_AMOUNT# &lt; 100 then NULL
					when #OS_AMOUNT# is null then 1
					else 0 END as IS_ENABLED 
		from ptraccount where account_id = #ACCOUNT_ID#
	 </select>
	 
 	<resultMap class="hmap" id="getHoldMailChecker">
		<result property="IS_ENABLED_HOLD_MAIL" javaType="long"/> 
	</resultMap>
	 
	<select id="getHoldMailChecker" resultMap="getHoldMailChecker">
		select CASE WHEN account.HOLD_MAIL = '1' THEN NULL 
					WHEN account.HOLD_MAIL = '0' THEN 1 
					ELSE 0 END as IS_ENABLED_HOLD_MAIL 
		from ptraccount account where account_id = #ACCOUNT_ID#
	 </select>
	 
 	<resultMap class="hmap" id="getLastPaymentDateChecker">
		<result property="IS_ENABLED_LPD" javaType="long" /> 
	</resultMap>
	 
	<select id="getLastPaymentDateChecker" resultMap="getLastPaymentDateChecker">
		select case when account.last_payment_date &lt; sf.PRINTING_DATE then 1 
					when account.last_payment_date > sf.PRINTING_DATE then NULL
					when account.last_payment_date is null then 1
					else 0 END as IS_ENABLED_LPD 
		from ptraccount account
		inner join PTRTREATMENT_SHORTFALL sf on sf.account_id = account.id
		where account.ID =#ACCOUNT_ID#
	 </select>
	 
	 	<select id="getLastPaymentDateCheckerNewTreatment" resultMap="getLastPaymentDateChecker">
		select case when account.last_payment_date &lt; #PRINTING_DATE# then 1 
					when account.last_payment_date &gt; #PRINTING_DATE# then NULL
					when account.last_payment_date is null then 1
					else 0 END as IS_ENABLED_LPD 
		from ptraccount account
		where account.ID =#ACCOUNT_ID#
	 </select>

	<resultMap id="getAuctionInfoForShortfallNotice" class="hmap">
		<result property="DATE_SOLD" javaType="date"/>
		<result property="SALES_PROCEED_AMOUNT" javaType="double"/>
	</resultMap>


	<select id="getAuctionInfoForShortfallNotice" resultMap="getAuctionInfoForShortfallNotice">
	select a.DATE_SOLD, a.SALES_PROCEED_AMOUNT from PTRTREATMENT_AUCTION a
	inner join ptrtreatment_type_status_ref ts on ts.id=a.type_status_id
	where ts.status_id=15004 and a.ACCOUNT_ID=#ACCOUNT_ID#
	order by a.TREATMENT_ID desc
	fetch first row only
	</select>

	<resultMap class="hmap" id="getTreatmentShortfallNotice">
		<result property="TREATMENT_ID" javaType="long" />
		<result property="PRINTING_DATE" javaType="date" jdbcType="DATE" />
		<result property="DATE_SOLD" javaType="date" jdbcType="DATE" />
		<result property="SALE_PROCEED_AMOUNT" javaType="double" />
		<result property="PAYOFF_AMOUNT" javaType="double" />
		<result property="PROVISION_CHARGES" javaType="double" />
		<result property="SHORTFALL_OUTSTANDING_BALANCE" javaType="double" />
		<result property="TEMPLATE_VERSION_ID" javaType="long"/>
	</resultMap>

	<select id="getTreatmentShortfallNotice" resultMap="getTreatmentShortfallNotice">
		select
		s.TREATMENT_ID,
		case when #PROCESS_STATUS_ID# = 15007 then current_date else s.PRINTING_DATE end as PRINTING_DATE,
		s.DATE_SOLD,
		s.SALES_PROCEED_AMOUNT,
		case when #PROCESS_STATUS_ID# = 15007 then a.payoff_amount else s.PAYOFF_AMOUNT end as PAYOFF_AMOUNT,
		s.PROVISION_CHARGES,
		s.SHORTFALL_OUTSTANDING_BALANCE,
		s.TEMPLATE_VERSION_ID
		from PTRTREATMENT_SHORTFALL s
		inner join ptraccount a on s.account_id = a.id
		where s.TREATMENT_ID = #ID#
 	</select>
	
	<parameterMap id="insertTreatmentShortfallNotice" class="map">
		<parameter property="PRINTING_DATE" javaType="date" jdbcType="DATE" />
		<parameter property="DATE_SOLD" javaType="date" jdbcType="DATE" />
		<parameter property="SALE_PROCEED_AMOUNT" jdbcType="NUMERIC"/>
		<parameter property="PAYOFF_AMOUNT" jdbcType="NUMERIC" />
		<parameter property="PROVISION_CHARGES" jdbcType="NUMERIC"/>
		<parameter property="SHORTFALL_OUTSTANDING_BALANCE" jdbcType="NUMERIC"/>
		<parameter property="TEMPLATE_VERSION_ID" jdbcType="NUMERIC"/>
		<parameter property="ACCOUNT_ID" javaType="long"/>
		<parameter property="ID" javaType="long" />
	</parameterMap>
	
	<insert id="insertTreatmentShortfallNotice" parameterMap="insertTreatmentShortfallNotice">
		insert into
		PTRTREATMENT_SHORTFALL
		(
		PRINTING_DATE,
		DATE_SOLD,
		SALES_PROCEED_AMOUNT,
		PAYOFF_AMOUNT,
		PROVISION_CHARGES,
		SHORTFALL_OUTSTANDING_BALANCE,
		TEMPLATE_VERSION_ID,
		ACCOUNT_ID,
		TREATMENT_ID
		) values (?, ?, ?, ?, ?, ?, ?, ?, ?)
	</insert>

	<update id="updatetTeatmentShortfallNotice" parameterMap="insertTreatmentShortfallNotice">
		update
		PTRTREATMENT_SHORTFALL
		set
		PRINTING_DATE = ?, 
		DATE_SOLD = ?, 
		SALES_PROCEED_AMOUNT = ?, 
		PAYOFF_AMOUNT = ?, 
		PROVISION_CHARGES = ?,
		SHORTFALL_OUTSTANDING_BALANCE = ?,
		TEMPLATE_VERSION_ID = ?,
		ACCOUNT_ID = ?
		where  TREATMENT_ID = ?
  	</update>

	<resultMap class="java.util.HashMap" id="getSixtyDays">
		<result property="60_DAYS" javaType="java.lang.Long"/>
	</resultMap>
	
	<select resultMap="getSixtyDays" id="getSixtyDays">
		SELECT 60 <include refid="fromdual"/>
	</select>

<resultMap class="hmap" id="getSaleProceeedAmount">
		<result property="SALE_PROCEED_AMOUNT" javaType="$"/>
		<result property="DATE_SOLD" javaType="date"/>
		<result property="SALE_PROCEED_DATE" javaType="date"/>
	</resultMap>
	
	<select resultMap="getSaleProceeedAmount" id="getSaleProceeedAmount">
	select a.SALES_PROCEED_AMOUNT, a.DATE_SOLD, a.SHORTFALL_DATE from PTRTREATMENT_AUCTION a
inner join ptrtreatment_type_status_ref ts on ts.id=a.type_status_id
where ts.status_id=15004
order by a.TREATMENT_ID desc
fetch first row only
	</select>
  	
  	<resultMap class="hmap" id="getTransactionShortfallDate">
  	<result property="SHORTFALL_DATE" javaType="date"/>
  	</resultMap>
  	
  	<select id="getTransactionShortfallDate" resultMap="getTransactionShortfallDate">
  	select current_date <include refid="fromdual"/>
  	<!-- select trans.transaction_date as SHORTFALL_DATE
	from ptrtransaction trans 
	inner join ptrtransaction_type_ref trf on (trans.transaction_type = trf.id)
	inner join PTRCHARGE_TYPE_REF ct on trans.CHARGE_TYPE_ID = ct.ID
	where trans.account_id = #ACCOUNT_ID# and trf.code in ('007','008') -->
  	</select>
  	
  	<resultMap class="hmap" id="getShortfallTlastIndicator">
  	<result property="TLAST_1" javaType="boolean"/>
  	<result property="TLAST_3" javaType="boolean"/>
  	<result property="TLAST_4" javaType="boolean"/>
  	<result property="TLAST_10" javaType="boolean"/>
  	<result property="TLAST_12" javaType="boolean"/>
  	<result property="TLAST_16" javaType="boolean"/>
  	<result property="TLAST_17" javaType="boolean"/>
  	<result property="TLAST_18" javaType="boolean"/>
  	<result property="TLAST_19" javaType="boolean"/>
  	<result property="TLAST_51" javaType="boolean"/>
  	<result property="TLAST_59" javaType="boolean"/>
  	<result property="TLAST_60" javaType="boolean"/>
  	<result property="TLAST_66" javaType="boolean"/>
  	</resultMap>
  	
  	<select id="getShortfallTlastIndicator" resultMap="getShortfallTlastIndicator">
	select 
		case when TLAST_VALUE_1 = 'Y' then 1 else 0 end as TLAST_1,
	   case when TLAST_VALUE_3 = 'Y' then 1 else 0 end as TLAST_3,
	   case when TLAST_VALUE_4 = 'Y' then 1 else 0 end as TLAST_4,
	   case when TLAST_VALUE_10 = 'Y' then 1 else 0 end as TLAST_10,
	   case when TLAST_VALUE_12 = 'Y' then 1 else 0 end as TLAST_12,
	   case when TLAST_VALUE_16 = 'Y' then 1 else 0 end as TLAST_16,
	   case when TLAST_VALUE_17 = 'Y' then 1 else 0 end as TLAST_17,
	   case when TLAST_VALUE_18 = 'Y' then 1 else 0 end as TLAST_18,
	    case when TLAST_VALUE_19 = 'Y' then 1 else 0 end as TLAST_19,
	    case when TLAST_VALUE_51 = 'Y' then 1 else 0 end as TLAST_51,
	    case when TLAST_VALUE_59 = 'Y' then 1 else 0 end as TLAST_59,
	    case when TLAST_VALUE_60 = 'Y' then 1 else 0 end as TLAST_60,
	    case when TLAST_VALUE_66 = 'Y' then 1 else 0 end as TLAST_66
	from ptraccount_tlast where account_id = cast(#ACCOUNT_ID# as bigint)
	
  	</select>
  	
  	<resultMap class="hmap" id="getShortfallTlastIndicatorNotShorfall">
  	<result property="TLAST_58" javaType="boolean"/>
  	</resultMap>
  	
  	<select id="getShortfallTlastIndicatorNotShorfall" resultMap="getShortfallTlastIndicatorNotShorfall">
  	select 1 as TLAST_58 from PTRACCOUNT_TLAST where TLAST_VALUE_58 &lt;&gt; 'Y' and ACCOUNT_ID = cast(#ACCOUNT_ID# as bigint)
  	</select>
  	
  	<resultMap class="hmap" id="getShortfallAccountIndicator">
  	<result property="OS_BALANCE_IS_LOWER" javaType="boolean"/>
  	<result property="LAST_PAYMENT_DATE_IS_GREATER" javaType="boolean"/>
  	<result property="HOLD_MAIL_IS_Y" javaType="boolean"/>
  	<result property="DAYS_IS_LOWER" javaType="boolean"/>
  	</resultMap>
	
	<select id="getShortfallAccountIndicator" resultMap="getShortfallAccountIndicator">
	select 
	case when acc.current_balance &lt; 100 then true else false end as OS_BALANCE_IS_LOWER,
	case when acc.last_payment_date > CAST(#SALES_PROCEED_DATE# as DATE) then 1 else 0 end as LAST_PAYMENT_DATE_IS_GREATER,
	case when acc.hold_mail_code_flag = '1' then true else false end as HOLD_MAIL_IS_Y,
	case when cast(#CURRENT_DATE# as date) - cast(coalesce(#DATE_SOLD#,#CURRENT_DATE#) as date) &lt; coalesce(s.DAY,0) then 1 else 0 end DAYS_IS_LOWER 
	from PTRACCOUNT acc
	left join ptrproduct_type_ref pro on (pro.id = acc.product_type_id)
    left join  ptrproduct_type_category_ref ptc on (ptc.id = pro.category_id)
    ,PTRSHORTFALL_VALIDATION_SETUP_REF s
	where acc.ID=#ACCOUNT_ID#
	and s.CODE='DAYS'
	</select>
	
	
	
	
	
	
	
	
	
	
<resultMap class="hmap" id="getShortfallValidationSetup">
<result property="DISABLE_TLAST_1" javaType="boolean"/>
<result property="DISABLE_TLAST_3" javaType="boolean"/>
<result property="DISABLE_TLAST_4" javaType="boolean"/>
<result property="DISABLE_TLAST_10" javaType="boolean"/>
<result property="DISABLE_TLAST_12" javaType="boolean"/>
<result property="DISABLE_TLAST_16" javaType="boolean"/>
<result property="DISABLE_TLAST_17" javaType="boolean"/>
<result property="DISABLE_TLAST_18" javaType="boolean"/>
<result property="DISABLE_TLAST_19" javaType="boolean"/>
<result property="DISABLE_TLAST_51" javaType="boolean"/>
<result property="DISABLE_TLAST_58" javaType="boolean"/>
<result property="DISABLE_TLAST_59" javaType="boolean"/>
<result property="DISABLE_TLAST_60" javaType="boolean"/>
<result property="DISABLE_TLAST_66" javaType="boolean"/>
<result property="DISABLE_DAYS_IS_LOWER" javaType="boolean"/>
<result property="DISABLE_OS_BALANCE_IS_LOWER" javaType="boolean"/>
<result property="DISABLE_SALES_PROCEED_AMOUNT" javaType="boolean"/>
<result property="DISABLE_LAST_PAYMENT_DATE_IS_GREATER" javaType="boolean"/>
<result property="DISABLE_HOLD_MAIL_IS_Y" javaType="boolean"/>
</resultMap>	

<select id="getShortfallValidationSetup" resultMap="getShortfallValidationSetup">
select
case when max(case when r.CODE='TLAST_1' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_1,
case when max(case when r.CODE='TLAST_3' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_3,
case when max(case when r.CODE='TLAST_4' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_4,
case when max(case when r.CODE='TLAST_10' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_10,
case when max(case when r.CODE='TLAST_12' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_12,
case when max(case when r.CODE='TLAST_16' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_16,
case when max(case when r.CODE='TLAST_17' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_17,
case when max(case when r.CODE='TLAST_18' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_18,
case when max(case when r.CODE='TLAST_19' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_19,
case when max(case when r.CODE='TLAST_51' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_51,
case when max(case when r.CODE='TLAST_58' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_58,
case when max(case when r.CODE='TLAST_59' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_59,
case when max(case when r.CODE='TLAST_60' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_60,
case when max(case when r.CODE='TLAST_66' then r.DISABLE end)=1 then true else false end as DISABLE_TLAST_66,
case when max(case when r.CODE='DAYS' then r.DISABLE end)=1 then true else false end as DISABLE_DAYS_IS_LOWER,
case when max(case when r.CODE='OS_BALANCE' then r.DISABLE end)=1 then true else false end as DISABLE_OS_BALANCE_IS_LOWER,
case when max(case when r.CODE='SALES_PROCEED_AMOUNT' then r.DISABLE end)=1 then true else false end as DISABLE_SALES_PROCEED_AMOUNT,
case when max(case when r.CODE='LAST_PAYMENT' then r.DISABLE end)=1 then true else false end as DISABLE_LAST_PAYMENT_DATE_IS_GREATER,
case when max(case when r.CODE='HOLD_MAIL' then r.DISABLE end)=1 then true else false end as DISABLE_HOLD_MAIL_IS_Y
from
(
select ID,CODE,case when DISABLE=true then 1 else 0 end as DISABLE,ROW_NUMBER() OVER(ORDER BY ID) AS RNUM from PTRSHORTFALL_VALIDATION_SETUP_REF
)r

</select>

<resultMap class="hmap" id="getShortfallDayValidationSetup">
<result property="SHORTFALL_DAY" javaType="long"/>
</resultMap>

<select id="getShortfallDayValidationSetup" resultMap="getShortfallDayValidationSetup">
select DAY from PTRSHORTFALL_VALIDATION_SETUP_REF where CODE='DAYS' and DISABLE=false
</select>

</sqlMap>

