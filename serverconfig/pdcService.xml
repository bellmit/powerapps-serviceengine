<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="pdcService">


<!-- <resultMap class="hmap" id="getPdcBank"> -->
<!-- <result property="ID" javaType="long"/> -->
<!-- <result property="DESCRIPTION" javaType="string"/> -->
<!-- <result property="BRANCH_DESCRIPTION" javaType="string"/> -->
<!-- <result property="BANK_ACCOUNT_NO" javaType="string"/> -->
<!-- </resultMap> -->

<!-- <select id="getPdcBank" resultMap="getPdcBank"> -->
<!-- select a.id, a.description, a.bank_branch, a.bank_account_number from ( -->
<!-- select NULL as id, '- Please Select -' as description, NULL as bank_branch, NULL as bank_account_number, -1 as sort_priority <include refid="fromdual"/> -->
<!-- union -->
<!-- select a.id as id, a.description||' - '||coalesce(b.description,'')  as description, coalesce(b.description,'') as bank_branch, null as bank_account_number, a.sort_priority -->
<!-- from ptrbank_ref a -->
<!-- left join ptrbank_branch_ref b on b.bank_id=a.id  -->
<!-- )a order by a.sort_priority, a.description asc -->
<!-- </select> -->

	<select id="getPdcBank" resultMap="global.ref">
		<include refid="pleaseSelectRef" />
		<include refid="fromdual" />
		union
		<include refid="refselect" />
		from ptrbank_ref		
	</select>
	
	<select id="getPdcBankBranch" resultMap="global.ref">
		select NULL, NULL, <include refid="pleaseSelectText"/>, false , -1 as SORT_PRIORITY
		<include refid="fromdual" />
		union
		select ID, ltrim(CODE, '0'), DESCRIPTION, DISABLE, SORT_PRIORITY
		from ptrbank_branch_ref
		WHERE bank_id=#BANK_ID#
		order by SORT_PRIORITY
	</select>
	
<insert id="insertTreatmentPdc" parameterClass="map">
insert into PTRTREATMENT_PDC (TREATMENT_ID,ACCOUNT_ID,TYPE_STATUS_ID,SUBTYPE_ID)
values (#ID#,#ACCOUNT_ID#,#TYPE_STATUS_ID#,#SUBTYPE_ID#)
</insert>

<resultMap class="hmap" id="getTreatmentPdc">
<result property="TYPE_STATUS_ID" javaType="long"/>
<result property="SUBTYPE_ID" javaType="long"/>
</resultMap>

<select id="getTreatmentPdc" resultMap="getTreatmentPdc">
select TYPE_STATUS_ID, SUBTYPE_ID from PTRTREATMENT_PDC where TREATMENT_ID=#ID#
</select>


<parameterMap class="map" id="insertTreatmentPdcDetails">
<parameter property="ID" jdbcType="NUMERIC"/>
<parameter property="PDC_CHEQUE_DATE" jdbcType="DATE"/>
<parameter property="PDC_CHEQUE_NUMBER" jdbcType="VARCHAR"/>
<parameter property="PDC_CHEQUE_AMOUNT" jdbcType="DOUBLE"/>
<parameter property="PDC_BNK_ACC_NO" jdbcType="VARCHAR"/>
<parameter property="PDC_BANK_BRANCH_ID" jdbcType="VARCHAR"/>
<parameter property="PDC_BANK_ID" jdbcType="NUMERIC"/>
<parameter property="PDC_LOCATION_PLACE" jdbcType="VARCHAR"/>
<parameter property="PDC_NXT_BNK_IN_DATE" jdbcType="DATE"/>
<parameter property="PDC_IFSC_CODE" jdbcType="VARCHAR"/>
<parameter property="PDC_MICR_CODE" jdbcType="VARCHAR"/>
<parameter property="PDC_RECEIPTING" jdbcType="DATE"/>
<parameter property="TREATMENT_ID" javaType="long"/>
<parameter property="PROCESS_REMARKS" javaType="string"/>
<parameter property="UPLOAD_CHEQUE_DOCUMENT_ID" javaType="long"/>
<parameter property="UPLOAD_CHEQUE_FILE_NAME" javaType="string"/>
<parameter property="UPLOAD_BOUNCED_SLIP_DOCUMENT_ID" javaType="long"/>
<parameter property="UPLOAD_BOUNCED_SLIP_FILE_NAME" javaType="string"/>
</parameterMap>

<insert id="insertTreatmentPdcDetails" parameterMap="insertTreatmentPdcDetails">
<selectKey resultClass="long" keyProperty="ID">
<include refid="sequencePrefix"/>PTRTREATMENT_PDC_DETAILS_ID<include refid="sequenceSuffix"/>
</selectKey>
insert into PTRTREATMENT_PDC_DETAILS
(ID,PDC_CHEQUE_DATE,PDC_CHEQUE_NUMBER,PDC_CHEQUE_AMOUNT,PDC_BNK_ACC_NO,
PDC_BANK_BRANCH,PDC_BANK_ID,PDC_LOCATION_PLACE,
PDC_NXT_BNK_IN_DATE,PDC_IFSC_CODE,PDC_MICR_CODE,PDC_RECEIPTING,
TREATMENT_ID,NOTES,UPLOAD_CHEQUE_DOCUMENT_ID,UPLOAD_CHEQUE_FILE_NAME,UPLOAD_BOUNCED_SLIP_DOCUMENT_ID,
UPLOAD_BOUNCED_SLIP_FILE_NAME)
values
(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
</insert>

<resultMap class="hmap" id="getTreatmentPdcDetails">
<result property="ID" javaType="long"/>
<result property="PDC_CHEQUE_DATE" javaType="date"/>
<result property="PDC_CHEQUE_NUMBER" javaType="string"/>
<result property="PDC_CHEQUE_AMOUNT" javaType="$"/>
<result property="PDC_BNK_ACC_NO" javaType="string"/>
<result property="PDC_BANK_BRANCH_ID" javaType="long"/>
<result property="PDC_BANK_ID" javaType="long"/>
<result property="PDC_LOCATION_PLACE" javaType="string"/>
<result property="PDC_NXT_BNK_IN_DATE" javaType="date"/>
<result property="PDC_IFSC_CODE" javaType="string"/>
<result property="PDC_MICR_CODE" javaType="string"/>
<result property="PDC_RECEIPTING" javaType="date"/>
<result property="TREATMENT_ID" javaType="long"/>
<result property="PROCESS_REMARKS" javaType="string"/>
<result property="UPLOAD_CHEQUE_DOCUMENT_ID" javaType="long"/>
<result property="UPLOAD_CHEQUE_FILE_NAME" javaType="string"/>
<result property="UPLOAD_BOUNCED_SLIP_DOCUMENT_ID" javaType="long"/>
<result property="UPLOAD_BOUNCED_SLIP_FILE_NAME" javaType="string"/>
</resultMap>

<select id="getTreatmentPdcDetails" resultMap="getTreatmentPdcDetails">

select
ID,PDC_CHEQUE_DATE,PDC_CHEQUE_NUMBER,PDC_CHEQUE_AMOUNT,PDC_BNK_ACC_NO,
cast(PDC_BANK_BRANCH as int8),PDC_BANK_ID,PDC_LOCATION_PLACE,
PDC_NXT_BNK_IN_DATE,PDC_IFSC_CODE,PDC_MICR_CODE,PDC_RECEIPTING,
TREATMENT_ID,NOTES,UPLOAD_CHEQUE_DOCUMENT_ID,UPLOAD_CHEQUE_FILE_NAME,UPLOAD_BOUNCED_SLIP_DOCUMENT_ID,
UPLOAD_BOUNCED_SLIP_FILE_NAME from PTRTREATMENT_PDC_DETAILS
where TREATMENT_ID=#ID#
</select>

<resultMap class="hmap" id="getPdcChequeNumber">
<result property="PDC_CHEQUE_NUMBER" javaType="string"/>
</resultMap>

<select id="getPdcChequeNumber" resultMap="getPdcChequeNumber">
select  cast(#PDC_CHEQUE_NUMBER# as bigint) + #NUMBER# as PDC_CHEQUE_NUMBER
</select>

<resultMap class="hmap" id="formatChequeNumber">
<result property="PDC_CHEQUE_NUMBER" javaType="string"/>
</resultMap>

<select id="formatChequeNumber" resultMap="formatChequeNumber">
select  lpad(#PDC_CHEQUE_NUMBER#, length(#PDC_CHEQUE_NUMBER_BEF#), '0' )
</select>





<resultMap class="hmap" id="getPDCChequeType">
<result property="ID" javaType="long"/>
<result property="DESCRIPTION" javaType="string"/>
<result property="DISABLE" javaType="boolean"/>
</resultMap>


<!-- where to map cheque type? -->
<select id="getPDCChequeType" resultMap="getPDCChequeType">
select a.id, a.description, a.disable from (
select NULL as id, '- Please Select -' as description, false as disable, -1 as sort_priority <include refid="fromdual"/>
<!-- union
select 1, 'N/A' as description, false, 1 as sort_priority <include refid="fromdual"/> -->
)a order by a.sort_priority
</select>



<!-- ## CAM PDC ## -->

<resultMap class="hmap" id="getCamPdcHost">
<result property="CHECK_NUMBER" javaType="string"/>
<result property="ISSUE_BANK" javaType="string"/>
<result property="CHECK_TYPE" javaType="string"/>
<result property="PLACE_OF_ISSUE" javaType="string"/>
<result property="CHECK_AMOUNT" javaType="$"/>

<result property="POSTING_AMOUNT" javaType="$"/>
<result property="CHECK_DATE" javaType="date"/>
<result property="DATE_RECEIVED" javaType="date"/>
<result property="BANK_CHARGE" javaType="$"/>
<result property="ACCEPTING_BRANCH" javaType="string"/>

<result property="LINK_STATUS" javaType="string"/>
<result property="ACCOUNT_POSTING" javaType="string"/>
<result property="STATUS_REMARK" javaType="string"/>
</resultMap>


<select id="getCamPdcHost" resultMap="getCamPdcHost">
select
NULL as CHECK_NUMBER,
NULL as ISSUE_BANK,
NULL as CHECK_TYPE,
NULL as PLACE_OF_ISSUE,
NULL as CHECK_AMOUNT,

NULL as POSTING_AMOUNT,
NULL as CHECK_DATE,
NULL as DATE_RECEIVED,
NULL as BANK_CHARGE,
NULL as ACCEPTING_BRANCH,

NULL as LINK_STATUS,
NULL as ACCOUNT_POSTING,
NULL as STATUS_REMARK
<include refid="fromdual"/>
</select>

<select id="getCamPdcPowerCollect" resultMap="getCamPdcHost">
select
d.pdc_cheque_number as CHECK_NUMBER,
br.description as ISSUE_BANK,
NULL as CHECK_TYPE,
d.pdc_location_place as PLACE_OF_ISSUE,
d.pdc_cheque_amount as CHECK_AMOUNT,

NULL as POSTING_AMOUNT,
d.pdc_cheque_date as CHECK_DATE,
NULL as DATE_RECEIVED,
NULL as BANK_CHARGE,
d.pdc_bank_branch as ACCEPTING_BRANCH,

NULL as LINK_STATUS,
a.account_no as ACCOUNT_POSTING,
d.notes as STATUS_REMARK
from ptrtreatment_pdc p
inner join ptraccount a on a.id=p.account_id
inner join ptrtreatment_pdc_details d on d.treatment_id=p.treatment_id
inner join ptrbank_ref br on br.id=d.pdc_bank_id
where p.account_id=#ACCOUNT_ID# and 
p.treatment_id=(select max(t.id) from ptrtreatment t where t.type_id=33 and a.id=t.account_id)
order by p.treatment_id desc, d.pdc_cheque_date desc
</select>

<resultMap class="hmap" id="getCamPdcReturnedCheque">
<result property="ACCOUNT_ID" javaType="long"/>
<result property="CHECK_RETURN_AMOUNT" javaType="$"/>
<result property="LATE_CHECK_RETURN_DATE" javaType="date"/>
<result property="CHEQUE_NUMBER" javaType="string"/>
</resultMap>


<select id="getCamPdcReturnedCheque" resultMap="getCamPdcReturnedCheque">
select  a.id, 
			null as LATE_CHECK_RETURN_DATE, 
			sum(trans.amount) as CHECK_RETURN_AMOUNT,
trans.cheque_number
		from ptraccount a, 
	     	ptrtransaction trans 
		where trans.account_id = a.id 
			and trans.auxilary_transaction_code in
   			('4610','4611','4612','4613','4614','4615','4616','4617','4618','4620','4625','4637','4668',
   			'4669','4670','4671','4672','4673','4674','4675','4677',
   			'4573','4575','4576','4619','4676','8609','8610','8611','8612','8613','8620','8621','8670','8673','8676')
    		and trans.input_source = 'Z' 
    	<!-- 	and a.late_check_return_date = trans.posting_date  -->
    		and a.id = #ACCOUNT_ID#
		group by a.id, trans.cheque_number
		
		</select>
</sqlMap>