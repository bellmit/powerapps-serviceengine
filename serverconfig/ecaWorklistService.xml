<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ecaWorklistService">

	<resultMap id="getEcaWorklist" class="hmap">
		<result property="ID" javaType="long" />
		<result property="CODE" javaType="string" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="CATEGORY" javaType="string" />
		<result property="REMARKS" javaType="string" />
		<result property="DISABLE" javaType="boolean" />
		<result property="CREATED_TIME" javaType="ts" />
		<result property="UPDATED_TIME" javaType="ts" />
		<result property="CREATED_BY" javaType="string" />
		<result property="UPDATED_BY" javaType="string" />
		<result property="TOTAL_ACCOUNT" javaType="long" />
	</resultMap>
	<select id="getEcaWorklist" resultMap="getEcaWorklist">
		SELECT R.ID,R.CODE,R.DESCRIPTION,TR.DESCRIPTION,R.REMARKS,
		R.DISABLE,R.CREATED_TIME,R.UPDATED_TIME,R.CREATED_BY,R.UPDATED_BY,0 as TOTAL_ACCOUNT  
		FROM PTRECA_WORKLIST R
		INNER JOIN PTRLEGAL_WORKLIST_CATEGORY_REF TR ON TR.ID=R.CATEGORY_ID
		<isNotEqual property="INCLUDE_ALL" compareValue="true">
			AND R.DISABLE = <include refid="false"/>
		</isNotEqual> 
		<isNotNull property="CATEGORY_ID">
			AND R.CATEGORY_ID=#CATEGORY_ID#
		</isNotNull>	
	</select>
	<resultMap id="getEcaWorklistCount" class="hmap">
		<result property="ID" javaType="long" />
		<result property="TOTAL_ACCOUNT" javaType="long" />
	</resultMap>
	<select id="getEcaWorklistCount" resultMap="getEcaWorklistCount">
		SELECT R.ID,COUNT(W.ACCOUNT_ID)
		FROM PTRECA_WORKLIST R
		INNER JOIN PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT W ON W.WORKLIST_ID=R.ID
		<isNotEqual property="INCLUDE_ALL" compareValue="true">
			AND R.DISABLE = <include refid="false"/>
		</isNotEqual> 
		<isNotNull property="CATEGORY_ID">
			AND R.CATEGORY_ID=#CATEGORY_ID#
		</isNotNull>
		GROUP BY R.ID	
	</select>
	
	<resultMap id="getEcaWorklistForEditing" class="hmap">
		<result property="CODE" javaType="string" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="CATEGORY_ID" javaType="long" />
		<result property="CENTRE_ID" javaType="long" />
		<result property="DISABLE" javaType="boolean" />
	</resultMap>
	<select id="getEcaWorklistForEditing" resultMap="getEcaWorklistForEditing">
		SELECT CODE,DESCRIPTION,CATEGORY_ID,CENTRE_ID,DISABLE
		FROM PTRECA_WORKLIST
		WHERE ID = #WORKLIST_ID#	
	</select>
	<insert id="insertEcaWorklist">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRECA_WORKLIST_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRECA_WORKLIST(ID,CODE,DESCRIPTION,CENTRE_ID,CATEGORY_ID,REMARKS,SORT_PRIORITY,CREATED_TIME,CREATED_BY)
		VALUES(#ID#,#CODE#,#DESCRIPTION#,#CENTRE_ID#,#CATEGORY_ID#,#REMARKS#,#ID#,#CURRENT_TIME#,#LOGON_USER#)	
	</insert>
	
	<update id="updateEcaWorklist">
		UPDATE PTRECA_WORKLIST SET
		CODE = #CODE#,
		DESCRIPTION = #DESCRIPTION#,
		CATEGORY_ID =#CATEGORY_ID#,
		CENTRE_ID = #CENTRE_ID#,
		REMARKS = #REMARKS#,
		DISABLE = #DISABLE#,
		UPDATED_BY = #LOGON_USER#,
		UPDATED_TIME =#CURRENT_TIME#
		WHERE ID=#WORKLIST_ID#	
	</update>
	
	<sql id="ecaWorklistAccountIdFragments">
		SELECT A.ID AS ACCOUNT_ID,ROW_NUMBER()OVER ()  as ROW_NUMBER
		FROM PTRACCOUNT A
		INNER JOIN PTRCUSTOMER C ON CAST(A.CUSTOMER_ID as BIGINT)= C.ID
		INNER JOIN PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT WA ON WA.ACCOUNT_ID=A.ID and WA.WORKLIST_ID=#WORKLIST_ID#
	</sql>
	<sql id="ecaWorklistSearchAccountIdFragments">
		SELECT A.ID AS ACCOUNT_ID,ROW_NUMBER()OVER ()  as ROW_NUMBER
		FROM PTRACCOUNT A
		INNER JOIN PTRCUSTOMER C ON CAST(A.CUSTOMER_ID as BIGINT)= C.ID
		INNER JOIN PTRPRODUCT_TYPE_REF R ON R.ID=A.PRODUCT_TYPE_ID
		INNER JOIN PTRPRODUCT_TYPE_CATEGORY_REF PC ON PC.ID=R.CATEGORY_ID
		WHERE
		<isNull property="CATEGORY_ID">
		1=1
		</isNull>
		<isEqual property="CATEGORY_ID" compareValue="1">
			PC.CODE ='IH'
		</isEqual>
		<isEqual property="CATEGORY_ID" compareValue="2">
			PC.CODE ='PF'
		</isEqual>
		<isEqual property="CATEGORY_ID" compareValue="3">
			PC.CODE ='PFI'
		</isEqual>
		<isNotEmpty property="CUSTOMER_NAME">
			AND UPPER(C.CUSTOMER_NAME) LIKE '%'||UPPER(#CUSTOMER_NAME#)||'%'
		</isNotEmpty>
		<isNotEmpty property="ACCOUNT_NUMBER">
			AND UPPER(A.ACCOUNT_NO) LIKE '%'||UPPER(#ACCOUNT_NUMBER#)||'%'
		</isNotEmpty>
		<isNotEmpty property="CUSTOMER_NUMBER">
			AND UPPER(C.CUSTOMER_ID_NO) LIKE '%'||UPPER(#CUSTOMER_NUMBER#)||'%'
		</isNotEmpty>
		AND NOT EXISTS(SELECT 1 FROM 
		PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT W WHERE W.ACCOUNT_ID=A.ID)
	</sql>	
	<resultMap id="getEcaWorklistAccountIds" class="hmap">
		<result property="ACCOUNT_ID" javaType="long" />
		<result property="RNUM" javaType="long" />
	</resultMap>
	<select id="getEcaWorklistAccountIds" resultMap="getEcaWorklistAccountIds">
		SELECT A.ACCOUNT_ID,A.ROW_NUMBER FROM
		(
		<include refid="ecaWorklistAccountIdFragments"/>
		) A 
		WHERE A.ROW_NUMBER BETWEEN (((#CURRENT_PAGE# - 1) * #LIMIT_BY#)+1) AND  (#CURRENT_PAGE# * #LIMIT_BY#)
	</select>
	
	<select id="getEcaWorklistSearchAccountIds" resultMap="getEcaWorklistAccountIds">
		SELECT A.ACCOUNT_ID,A.ROW_NUMBER FROM
		(
		<include refid="ecaWorklistSearchAccountIdFragments"/>
		) A 
		WHERE A.ROW_NUMBER BETWEEN (((#CURRENT_PAGE# - 1) * #LIMIT_BY#)+1) AND  (#CURRENT_PAGE# * #LIMIT_BY#)
	</select>	
	<resultMap id="getEcaWorklistAccountTotalCount" class="hmap">
		<result property="TOTAL_RECORD" javaType="long" />
		<result property="TOTAL_PAGE" javaType="long" />
	</resultMap>
	<select id="getEcaWorklistAccountTotalCount" resultMap="getEcaWorklistAccountTotalCount">
		SELECT 
		COUNT(A.ACCOUNT_ID) as TOTAL_RECORD,
		CEIL(COUNT(A.ACCOUNT_ID)/CAST(#LIMIT_BY# AS DECIMAL)) AS TOTAL_PAGE
		FROM
		(
		<include refid="legalWorklistAccountIdFragments"/>
		) A 
	</select>

	<select id="getEcaWorklistSearchAccountTotalCount" resultMap="getEcaWorklistAccountTotalCount">
		SELECT 
		COUNT(A.ACCOUNT_ID) as TOTAL_RECORD,
		CEIL(COUNT(A.ACCOUNT_ID)/CAST(#LIMIT_BY# AS DECIMAL)) AS TOTAL_PAGE
		FROM
		(
		<include refid="legalWorklistSearchAccountIdFragments"/>
		) A 
	</select>
			
	<resultMap class="hmap" id="getEcaWorklistSearchAccountResults">
		<result property="ACCOUNT_ID" javaType="long" />
		<result property="ACCOUNT_NUMBER" javaType="string" />
		<result property="CUSTOMER_ID" javaType="string" />
		<result property="CUSTOMER_NAME" javaType="string" />
		<result property="CUSTOMER_NUMBER" javaType="string" />
		<result property="PRODUCT_TYPE" javaType="string" />
		<result property="PRODUCT_CATEGORY" javaType="string" />
		<result property="ACCOUNT_STATUS" javaType="string" />
		<result property="LAST_PAYMENT_DATE" javaType="date" />
		<result property="LAST_PAYMENT_AMOUNT" javaType="$" />
		<result property="PAYOFF_AMOUNT" javaType="$" />
		<result property="NPF_DATE" javaType="date" />
		<result property="CHARGE_OFF_DATE" javaType="date" />
		<result property="CURRENT_BALANCE" javaType="$" />
		<result property="OUTSTANDING_BALANCE" javaType="$" />
		<result property="MONTHS_IN_ARREARS" javaType="long" />
	</resultMap>
	<select id="getEcaWorklistSearchAccountResults" resultMap="getEcaWorklistSearchAccountResults">
		SELECT A.ID,A.ACCOUNT_NO,C.ID,C.CUSTOMER_NAME,C.CUSTOMER_NO,R.DESCRIPTION AS PRODUCT_TYPE ,
		PR.DESCRIPTION AS PRODUCT_CATEGORY,STATUS.DESCRIPTION AS ACCOUNT_STATUS,
		A.LAST_PAYMENT_DATE,A.LAST_PAYMENT_AMOUNT,A.PAYOFF_AMOUNT,A.NPL_DATE,A.CHARGE_OFF_DATE,A.CURRENT_BALANCE,A.OUTSTANDING_BALANCE,
		A.MONTHS_IN_ARREARS
		FROM PTRACCOUNT A
		INNER JOIN PTRCUSTOMER C ON CAST(A.CUSTOMER_ID AS BIGINT)=C.ID
		INNER JOIN PTRPRODUCT_TYPE_REF R ON R.ID=A.PRODUCT_TYPE_ID
		INNER JOIN PTRPRODUCT_TYPE_CATEGORY_REF PR ON PR.ID=R.CATEGORY_ID
		INNER JOIN PTRACCOUNT_STATUS_REF STATUS ON STATUS.ID=A.STATUS_ID		
		<isNotEmpty property="ACCOUNTS">
			where A.ID in(<iterate property="ACCOUNTS" conjunction=",">#ACCOUNTS[]#</iterate>)
		</isNotEmpty>
		<isEmpty property="ACCOUNTS">
			where 1 = 0
		</isEmpty>
	</select>
	
	<resultMap class="hmap" id="getEcaWorklistAssigmentDetails">
		<result property="ID" javaType="long" />
		<result property="ACCOUNT_ID" javaType="long" />
		<result property="ASSIGNMENT_DATE" javaType="date" />
		<result property="ASSIGNED_BY" javaType="string" />
	</resultMap>
	<select id="getEcaWorklistAssigmentDetails" resultMap="getEcaWorklistAssigmentDetails">
		select ID,ACCOUNT_ID,ASSIGNMENT_DATE,ASSIGNED_BY
		from PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT
		<isNotEmpty property="ACCOUNTS">
			where ACCOUNT_ID in(<iterate property="ACCOUNTS" conjunction=",">#ACCOUNTS[]#</iterate>)
		</isNotEmpty>
		<isEmpty property="ACCOUNTS">
			where 1 = 0
		</isEmpty>
	</select>
	<resultMap class="hmap" id="getEcaWorklistCategoryId">
		<result property="CATEGORY_ID" javaType="long" />
	</resultMap>
	<select id="getEcaWorklistCategoryId" resultMap="getEcaWorklistCategoryId">
		select CATEGORY_ID FROM PTRECA_WORKLIST
		WHERE ID=#ID#
	</select>
	<resultMap class="hmap" id="getEcaWorklistForTransfer">
		<result property="ID" javaType="long" />
		<result property="DESCRIPTION" javaType="string" />
	</resultMap>
	<select id="getEcaWorklistForTransfer" resultMap="getEcaWorklistForTransfer">
		SELECT ID,DESCRIPTION FROM PTRECA_WORKLIST
		WHERE DISABLE =<include refid="false"/> AND CATEGORY_ID=#CATEGORY_ID#
		AND ID !=#ID#
	</select>	
	<insert id="assignAccountToEcaWorklist">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT(ID,ACCOUNT_ID,WORKLIST_ID,ASSIGNMENT_DATE,ASSIGNED_BY,TRANSFERED_ASSIGNMENT_ID)
		VALUES(#ID#,#ACCOUNT_ID#,#WORKLIST_ID#,#CURRENT_TIME#,#LOGON_USER#,#TRANSFERED_ASSIGNMENT_ID#)	
	</insert>
	<delete id="deleteAccountFromEcaWorklist">
		DELETE FROM PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT WHERE ID=#ID#
	</delete>
	<insert id="assignAccountToEcaWorklistHistory">	
		INSERT INTO PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT_HISTORY(ID,ACCOUNT_ID,WORKLIST_ID,ASSIGNMENT_DATE,ASSIGNED_BY,TRANSFERED_ASSIGNMENT_ID)
		VALUES(#ID#,#ACCOUNT_ID#,#WORKLIST_ID#,#CURRENT_TIME#,#LOGON_USER#,#TRANSFERED_ASSIGNMENT_ID#)	
	</insert>
	<update id="updateAccountEcaWorklistHistory">
		UPDATE PTRACCOUNT_ECA_WORKLIST_ASSIGNMENT_HISTORY SET
		REMOVED_DATE = #CURRENT_TIME#,
		REMOVED_BY = #LOGON_USER#
		WHERE ID=#ID#
	</update>
	<resultMap id="getAvailableEcaUsersForWorklist" class="hmap">
		<result property="USER_ID" javaType="string" />
		<result property="FIRST_NAME" javaType="string" />
		<result property="MIDDLE_NAME" javaType="string" />
		<result property="LAST_NAME" javaType="string" />
		<result property="DESIGNATION" javaType="string" />
	</resultMap>
	<select id="getAvailableEcaUsersForWorklist" resultMap="getAvailableEcaUsersForWorklist">
		SELECT U.USER_ID,E.FIRST_NAME,E.MIDDLE_NAME,E.LAST_NAME,E.DESIGNATION 
		FROM PTRUSER U
		INNER JOIN PTREMPLOYEE E ON E.ID=U.EMPLOYEE_ID
		INNER JOIN PTRUSER_GROUP_REF G ON G.ID=U.USER_GROUP_ID AND G.CODE='LEGAL'
		WHERE (U.DISABLE = <include refid="false"/> OR U.DISABLE IS NULL) and 
		NOT EXISTS(SELECT 1 FROM PTRECA_USER_WL_ASSIGN WA 
		WHERE WA.USER_ID=U.USER_ID AND WA.WORKLIST_ID =#ID#)
	</select>

	<resultMap id="getAssignedEcaUsersForWorklist" class="hmap">
		<result property="ID" javaType="long" />
		<result property="USER_ID" javaType="string" />
		<result property="FIRST_NAME" javaType="string" />
		<result property="MIDDLE_NAME" javaType="string" />
		<result property="LAST_NAME" javaType="string" />
		<result property="DESIGNATION" javaType="string" />
	</resultMap>
	<select id="getAssignedEcaUsersForWorklist" resultMap="getAssignedEcaUsersForWorklist">
		SELECT WL.ID,U.USER_ID,E.FIRST_NAME,E.MIDDLE_NAME,E.LAST_NAME,E.DESIGNATION 
		FROM PTRUSER U
		INNER JOIN PTRECA_USER_WL_ASSIGN WL ON WL.USER_ID=U.USER_ID AND WL.WORKLIST_ID=#WORKLIST_ID#
		INNER JOIN PTREMPLOYEE E ON E.ID=U.EMPLOYEE_ID
		INNER JOIN PTRUSER_GROUP_REF G ON G.ID=U.USER_GROUP_ID AND G.CODE='LEGAL'
	</select>
		
	<insert id="assignUserToEcaWorklist">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRECA_USER_WL_ASSIGN_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRECA_USER_WL_ASSIGN(ID,USER_ID,WORKLIST_ID)
		VALUES(#ID#,#USER_ID#,#WORKLIST_ID#)	
	</insert>
	<delete id="deleteUserFromEcaWorklist">
		DELETE FROM PTRECA_USER_WL_ASSIGN WHERE ID=#ID#
	</delete>
	<insert id="assignUserToEcaWorklistHistory">	
		INSERT INTO PTRECA_USER_WL_ASSIGN_HISTORY(ID,USER_ID,WORKLIST_ID,ASSIGNMENT_DATE,ASSIGNED_BY)
		VALUES(#ID#,#USER_ID#,#WORKLIST_ID#,#CURRENT_TIME#,#LOGON_USER#)	
	</insert>
	<update id="updateUserEcaWorklistHistory">
		UPDATE PTRECA_USER_WL_ASSIGN_HISTORY SET
		REMOVED_DATE = #CURRENT_TIME#,
		REMOVED_BY = #LOGON_USER#
		WHERE ID=#ID#
	</update>
	
	<select id="getEcaAssignmentEvaluationTree" resultMap="global.ref">
		<include refid="refselect" /> 
		FROM PTRECA_ASSIGNMENT_TREE
		WHERE SUBTYPE_ID =#SUBTYPE_ID#  and PRODUCT_CATEGORY_ID=#PRODUCT_CATEGORY_ID#
	</select>
		
	<resultMap id="getEcaAssignmentEvaluationTreeDocumentId" class="hmap">
		<result property="DOCUMENT_ID" javaType="long" />
	</resultMap>
	<select id="getEcaAssignmentEvaluationTreeDocumentId" resultMap="getEcaAssignmentEvaluationTreeDocumentId">
		SELECT DOCUMENT_ID FROM PTRECA_ASSIGNMENT_TREE WHERE ID=#ID#	
	</select>

	<select id="getEcaAssignmentEvaluationTreeBuckets" resultMap="global.ref">
		<include refid="refselect" /> 
		FROM PTRECA_WORKLIST
	</select>	
	<insert id="insertEcaAssignmentEvaluationTree">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRECA_ASSIGNMENT_TREE_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRECA_ASSIGNMENT_TREE(ID,CODE,DESCRIPTION,IS_BATCH,IS_IMPORT,SUBTYPE_ID,REMARKS,SORT_PRIORITY,CREATED_TIME,CREATED_BY,PRODUCT_CATEGORY_ID)
		VALUES(#ID#,#CODE#,#DESCRIPTION#,#IS_BATCH#,#IS_IMPORT#,#SUBTYPE_ID#,#REMARKS#,#ID#,#CURRENT_TIME#,#LOGON_USER#,#PRODUCT_CATEGORY_ID#)	
	</insert>
	
	<update id="updateEcaAssignmentEvaluationTree">
		UPDATE PTRECA_ASSIGNMENT_TREE SET
		CODE = #CODE#,
		DESCRIPTION = #DESCRIPTION#,
		SUBTYPE_ID =#SUBTYPE_ID#,
		PRODUCT_CATEGORY_ID=#PRODUCT_CATEGORY_ID#,
		IS_BATCH = #IS_BATCH#,
		IS_IMPORT = #IS_IMPORT#,
		REMARKS = #REMARKS#,
		DISABLE = #DISABLE#,
		UPDATED_BY = #LOGON_USER#,
		UPDATED_TIME =#CURRENT_TIME#
		WHERE ID=#ID#	
	</update>
	
	<update id="updateEcaAssignmentEvaluationTreeContent">
		UPDATE PTRECA_ASSIGNMENT_TREE SET DOCUMENT_ID = #DOCUMENT_ID#, 
		REMARKS = #REMARKS#, UPDATED_BY = #LOGON_USER#, UPDATED_TIME =#CURRENT_TIME#
		WHERE ID =#ID#
	</update>
	<resultMap id="getEcaAssignmentTreeForEditing" class="hmap">
		<result property="CODE" javaType="string" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="SUBTYPE_ID" javaType="long" />
		<result property="IS_BATCH" javaType="boolean" />
		<result property="DISABLE" javaType="boolean" />
	</resultMap>
	<select id="getEcaAssignmentTreeForEditing" resultMap="getEcaAssignmentTreeForEditing">
		SELECT CODE,DESCRIPTION,SUBTYPE_ID,IS_BATCH,DISABLE
		FROM PTRECA_ASSIGNMENT_TREE
		WHERE ID = #ID#	
	</select>		
</sqlMap>