<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="akpkApprovalMatrixService">

<resultMap class="hmap" id="getakpkMatrixApprovalTemplates">
<result property="ID" javaType="long"/>
<result property="CODE" javaType="string"/>
<result property="DESCRIPTION" javaType="string"/>
<result property="TEMPLATE_ID" javaType="long"/>
<result property="DISABLE" javaType="boolean"/>
<result property="SORT_PRIORITY" javaType="long"/>
</resultMap>

<select id="getakpkMatrixApprovalTemplates" resultMap="getakpkMatrixApprovalTemplates">
select NULL as ID, NULL as CODE, 'Please Select' as NAME, NULL as TEMPLATE_ID, false as DISABLE, -1 as SORT_PRIORITY
union
select tv.ID, type.CODE, t.NAME, t.ID as TEMPLATE_ID, tv.DISABLE, 1 as SORT_PRIORITY
from PTRTEMPLATE t
inner join PTRTEMPLATE_TYPE_REF type on t.TEMPLATE_TYPE_ID = type.ID
inner join PTRTEMPLATE_VERSION tv on t.ID = tv.TEMPLATE_ID
inner join PTRPRODUCT_TYPE_CATEGORY_REF ptc on ptc.ID=t.PRODUCT_TYPE_CATEGORY_ID
inner join PTRPRODUCT_TYPE_REF pro on pro.category_id=ptc.ID
inner join PTRACCOUNT a on a.PRODUCT_TYPE_ID=pro.ID
where t.DISABLE = false and type.code='RNR'
</select>

<select id="getakpkMatrixApprovalActions" resultMap="global.ref">
<include refid="refselect"/> from (values
(NULL,'',' Please Select ',false,-1),
(1,'E','Escalate to HOD',false,1),
(2,'D','Dispute',false,2)
)as a (ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY)
</select>

<insert id="insertAkpkBlanketApprovalAccount" parameterClass="map">
insert into ptrakpk_blanket_approval_account
(account_id, created_user_id, created_time)
values (#ACCOUNT_ID#, #CREATED_USER_ID#, #CREATED_TIME#)
</insert>

<insert id="insertAkpkBlanketApprovalAccountHistory" parameterClass="map">
insert into ptrakpk_blanket_approval_account_history
(account_id, created_user_id, created_time)
values (#ACCOUNT_ID#, #CREATED_USER_ID#, #CREATED_TIME#)
</insert>


<delete id="deleteAkpkBlanketApprovalAccount" parameterClass="map">
delete from ptrakpk_blanket_approval_account
</delete>

<update id="updateAkpkBlanketApprovalAccount" parameterClass="map">
update ptrakpk_blanket_approval_account set action_id=#ACTION_ID# where ACCOUNT_ID=#ACCOUNT_ID#
</update>

<resultMap class="hmap" id="getakpkMatrixApprovalNOA">
<result javaType="long" property="NUMBER_OF_ACCOUNTS"/>
</resultMap>
<select id="getakpkMatrixApprovalNOA" resultMap="getakpkMatrixApprovalNOA">
select count(a.account_id) from ptrakpk_blanket_approval_account a where a.action_id is null
</select>

<resultMap class="hmap" id="getakpkMatrixApprovalAccounts">
<result javaType="long" property="ACCOUNT_ID"/>
<result javaType="long" property="CUSTOMER_ID"/>
</resultMap>
<select id="getakpkMatrixApprovalAccounts" resultMap="getakpkMatrixApprovalAccounts">
select a.id, a.customer_id from (
select a.id, a.customer_id, row_number() over(order by a.ID) as RNUM from PTRACCOUNT a 
inner join ptrakpk_blanket_approval_account b on b.account_id=a.id
where b.action_id is null
) a
where
a.RNUM   
between (1 + ((cast(#PAGE_NUMBER# AS NUMERIC)  - 1) * #LIMIT_RESULT:NUMERIC#)) 
and (#LIMIT_RESULT:NUMERIC# * cast(#PAGE_NUMBER# AS NUMERIC))
</select>

<select id="getakpkMatrixApprovalDisputeAccounts" resultMap="getakpkMatrixApprovalAccounts">
select a.id, a.customer_id from PTRACCOUNT a 
inner join ptrakpk_blanket_approval_account b on b.account_id=a.id
where b.action_id = 2
</select>

<resultMap class="hmap" id="getRnrProcessTypeId">
<result property="PROCESS_TYPE_ID" javaType="long"/>
<result property="TYPE_STATUS_ID" javaType="long"/>
<result property="STATUS_ID" javaType="long"/>
</resultMap>

<select id="getRnrProcessTypeId" resultMap="getRnrProcessTypeId">
select t.id, ty.id, ty.status_id from ptrtreatment_type_ref t 
inner join ptrtreatment_type_status_ref ty on ty.type_id=t.id
where t.id=49 and ty.code='RNR_PHOD1'
</select>


</sqlMap>