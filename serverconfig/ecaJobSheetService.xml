<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ecaJobSheetService">

<!-- ## TREATMENT ## -->

	<insert id="insertTreatmentEcaJobSheet">
	insert into ptrtreatment_eca_jobsheet (TREATMENT_ID,ACCOUNT_ID,TYPE_STATUS_ID,SUBTYPE_ID,
	ACTION_TIME,PHONE_NO,PTP_DATE,PTP_AMOUNT,USER_ID)
	values (#ID#, #ACCOUNT_ID#,#TYPE_STATUS_ID#,#SUBTYPE_ID#,
	#ACTION_TIME#,#PHONE_NO#,#PROMISE_DATE#,#PTP_AMOUNT#,#USER_ID#)
	</insert>
	
	<update id="updateTreatmentEcaJobSheet">
	update ptrtreatment_eca_jobsheet set TYPE_STATUS_ID=#TYPE_STATUS_ID#, SUBTYPE_ID = #SUBTYPE_ID# where TREATMENT_ID=#ID#
	</update>
	
	<resultMap id="getTreatmentEcaJobSheet" class="hmap">
	<result property="TYPE_STATUS_ID" javaType="long" />
	<result property="SUBTYPE_ID" javaType="long" />
	<result property="ACTION_DATE" javaType="ts" />
	<result property="ACTION_TIME" javaType="string" />
	<result property="PHONE_NO" javaType="string" />
	<result property="PTP_AMOUNT" javaType="$" />
	<result property="PTP_DATE" javaType="date" />
	<result property="USER_ID" javaType="string" />
	<result property="NAME_ECA" javaType="string" />
	</resultMap>	
	
	<select id="getTreatmentEcaJobSheet" resultMap="getTreatmentEcaJobSheet">		
	SELECT e.TYPE_STATUS_ID,e.SUBTYPE_ID,
	e.ACTION_TIME,
	to_char(e.ACTION_TIME,'HH:MI PM'),
	e.PHONE_NO,
	e.PTP_AMOUNT,
	e.PTP_DATE,
	e.USER_ID,
	g.description as NAME_ECA
	 FROM ptrtreatment_eca_jobsheet e
	 inner join ptrtreatment t on t.id=e.treatment_id
	 inner join ptragency g on g.id=t.agency_id
	 WHERE e.TREATMENT_ID=#ID#
	</select>	
	
<!-- ## IMPORT ## -->	
	
	
<resultMap class="hmap" id="getEcaJobSheetValidCustomers">
	<result property="CUSTOMER_ID" javaType="long" />
	<result property="CUSTOMER_PRIMARY_ID" javaType="string" />
	<result property="CUSTOMER_NAME" javaType="string" />
	<result property="VALID" javaType="boolean" />
	<result property="COLOR" javaType="string" />
	<result property="CUSTOMER_CIF" javaType="string"/>
	<result property="ACCOUNT_ID" javaType="long"/>
	<result property="ACCOUNT_NO" javaType="string"/>
	<result property="PROCESS_TYPE_ID" javaType="long"/>
	<result property="TRUE" javaType="boolean"/>
	<result property="FALSE" javaType="boolean"/>
	<result property="PRODUCT_TYPE" javaType="string"/>
	<result property="AGENCY_ID" javaType="long"/>
	<result property="AGENCY_ASSIGNMENT_ID" javaType="long"/>
</resultMap>

	<select id="getEcaJobSheetValidCustomers" resultMap="getEcaJobSheetValidCustomers">
		select c.ID, c.CUSTOMER_ID_NO, c.CUSTOMER_NAME, true as VALID, '33ff33' as
		COLOR, c.CUSTOMER_NO, acc.ID, acc.ACCOUNT_NO, 48 as PROCESS_TYPE_ID,
		<include refid="true"/>, <include refid="false"/>, cat.DESCRIPTION,
		ass.AGENCY_ID, ass.ID
		 from PTRCUSTOMER c
		inner join PTRACCOUNT acc on acc.CUSTOMER_ID=c.ID
		inner join ptrproduct_type_ref pr on (acc.product_type_id = pr.id)
		inner join ptrproduct_type_category_ref cat on (pr.category_id = cat.id)
		inner join PTRACCOUNT_AGENCY_ASSIGNMENT ass on ass.ACCOUNT_ID=acc.ID
			<iterate prepend="where acc.ACCOUNT_NO in " conjunction="," property="ACCOUNTS" open="(" close=")">#ACCOUNTS[]#</iterate>
			 and ass.AGENCY_ID=#AGENCY_ID# and ass.STATUS_ID=15007 and
			 ass.acknowledged_date is not null and exists 
			(select 1 from PTRACCOUNT a where a.CUSTOMER_ID=c.ID)
	</select>
	
	<resultMap class="hmap" id="getEcaJobSheetTypeStatus">
	<result property="STATUS_ID" javaType="long"/>
	<result property="TYPE_STATUS_ID" javaType="long"/>
	</resultMap>
	
	<select id="getEcaJobSheetTypeStatus" resultMap="getEcaJobSheetTypeStatus">
	select STATUS_ID, ID from PTRTREATMENT_TYPE_STATUS_REF where UPPER(DESCRIPTION)=UPPER(#TYPE_STATUS#)
	</select>
	
	<resultMap class="hmap" id="getEcaJobSheetSubtype">
	<result property="SUBTYPE_ID" javaType="long"/>
	</resultMap>
	
	<select id="getEcaJobSheetSubtype" resultMap="getEcaJobSheetSubtype">
	select ID from PTRTREATMENT_SUBTYPE_REF where UPPER(CODE)=UPPER(#ACTION_CODE#)
	</select>
	
	<resultMap class="hmap" id="getEcaJobSheetTimestamp">
	<result property="TIMESTAMP" javaType="ts"/>
	</resultMap>
	<resultMap class="hmap" id="getEcaJobSheetPtpDate">
	<result property="PROMISE_DATE" javaType="date"/>
	</resultMap>
	
	<select id="getEcaJobSheetTimestamp" resultMap="getEcaJobSheetTimestamp">
	select to_timestamp(#TIMESTAMP#,'MM/DD/YYYY HH:MI PM') <include refid="fromdual"/>
	</select>
	
	<select id="getEcaJobSheetPtpDate" resultMap="getEcaJobSheetPtpDate">
	select to_date(#PTP_DATE#,'MM/DD/YYYY') <include refid="fromdual"/>
	</select>
	
</sqlMap>