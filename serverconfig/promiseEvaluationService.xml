<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="promiseEvaluationService">

<resultMap id="getInprogressTreatmentPTP" class="hmap">
<result property="ACCOUNT_ID" javaType="long"/>
<result property="ID" javaType="long"/>
<result property="BROKEN_PROMISE" javaType="boolean"/>
<result property="CREATED_USER_ID" javaType="string"/>
<result property="CREATED_TIME" javaType="ts"/>
<result property="PROCESS_TYPE_ID" javaType="long"/>
<result property="TREATMENT_SOURCE_ID" javaType="long"/>
<result property="NOTE_TEXT" javaType="string"/>
</resultMap>

<select id="getInprogressTreatmentPTP" resultMap="getInprogressTreatmentPTP">
SELECT 
T.ACCOUNT_ID,
T.ID,
CASE 
WHEN SUM(PTP.AMOUNT) - COALESCE(SUM(PT.AMOUNT),0) &lt;= 0 THEN 0 
WHEN SUM(PTP.AMOUNT) - COALESCE(SUM(PT.AMOUNT),0) > 0 
AND CAST(PTP.DUE_TIME as DATE) + CAST(#GRACE_PERIOD# as INT) &lt; CAST(#EFFECTIVE_DATE# as DATE) THEN 1 END AS BROKEN_PROMISE,
T.CREATED_USER_ID,
T.CREATED_TIME,
T.TYPE_ID,
T.TREATMENT_SOURCE_ID,
note.NOTE_TEXT
FROM PTRACCOUNT A
INNER JOIN PTRTREATMENT T ON T.ACCOUNT_ID = A.ID
INNER JOIN PTRTREATMENT_PTP PTP ON PTP.TREATMENT_ID = T.ID
left join PTRTREATMENT_NOTE note on note.treatment_id=t.id
left join PTRPAYMENT_TRANSACTION PT ON (PT.ACCOUNT_ID=A.ID AND PT.POSTING_DATE >= CAST(T.CREATED_TIME AS DATE))
WHERE T.STATUS_ID = 15007
GROUP BY T.ACCOUNT_ID, T.ID, PTP.DUE_TIME, T.CREATED_USER_ID, T.CREATED_TIME, T.UPDATED_TIME, T.TYPE_ID, T.TREATMENT_SOURCE_ID, note.NOTE_TEXT
</select>

<resultMap class="hmap" id="getPromiseEvaluationSuccessfulStatuses">
<result property="PROCESS_TYPE_ID" javaType="long"/>
<result property="SUCCESSFUL_TYPE_STATUS_ID" javaType="long"/>
<result property="SUCCESSFUL_STATUS_ID" javaType="long"/>
</resultMap>

<select id="getPromiseEvaluationSuccessfulStatuses" resultMap="getPromiseEvaluationSuccessfulStatuses">
select
tt.ID as PROCESS_TYPE_ID,
rr.ID as TYPE_STATUS_ID,
rr.STATUS_ID
from ptrtreatment_type_ref tt
inner join PTRTREATMENT_TYPE_STATUS_REF rr on rr.TYPE_ID = tt.ID
where tt.ID = 2 and rr.STATUS_ID = 15004
</select>

<resultMap class="hmap" id="getPromiseEvaluationUnsuccessfulStatuses">
<result property="PROCESS_TYPE_ID" javaType="long"/>
<result property="UNSUCCESSFUL_TYPE_STATUS_ID" javaType="long"/>
<result property="UNSUCCESSFUL_STATUS_ID" javaType="long"/>
</resultMap>

<select id="getPromiseEvaluationUnsuccessfulStatuses" resultMap="getPromiseEvaluationUnsuccessfulStatuses">
select
tt.ID as PROCESS_TYPE_ID,
rr.ID as TYPE_STATUS_ID,
rr.STATUS_ID
from ptrtreatment_type_ref tt
inner join PTRTREATMENT_TYPE_STATUS_REF rr on rr.TYPE_ID = tt.ID
where tt.ID = 2 and rr.STATUS_ID = 15001
</select>


</sqlMap>