<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="legalActionService">
	<select id="getStatusForFollowUpEditor" resultMap="global.ref">
	<isNotNull property="PROCESS_ID">
		<include refid="pleaseSelectRef"/>
		union
		<include refid="refselect" /> 
		FROM PTRTREATMENT_STATUS_REF
		WHERE ID IN (15004,15005,15001,15007)	
	</isNotNull>
	<isNull property="PROCESS_ID">
		<include refid="refselect" /> 
		FROM PTRTREATMENT_STATUS_REF
		WHERE ID = 15007
	</isNull>
	</select>
	<select id="getStatusForActionEditor" resultMap="global.ref">
		<include refid="pleaseSelectRef"/>
		union
		<include refid="refselect" /> 
		FROM PTRTREATMENT_STATUS_REF
		WHERE ID IN (15004,15005,15001,15007)	
	</select>
	<select id="getAuctionStatus" resultMap="global.ref">
		<include refid="pleaseSelectRef"/>
		union
		<include refid="refselect" /> 
		FROM PTRLEGAL_ACTION_AUCTION_STATUS_REF	
	</select>
	<select id="getLegalInstitutionLevel" resultMap="global.ref">
		<include refid="pleaseSelectRef"/>
		union
		<include refid="refselect" /> 
		FROM PTRINSTITUTION_LEVEL_REF	
	</select>
	<select id="getContestedStatus" resultMap="global.ref">
		<include refid="pleaseSelectRef"/>
		union
		select 0 as ID, 'NO' as CODE,'No' DESCRIPTION, <include refid="false"/> as DISABLE, 0 as SORT_PRIORITY <include refid="fromdual"/>
		union
		select 1 as ID, 'YES' as CODE,'Yes' DESCRIPTION, <include refid="false"/> as DISABLE, 1 as SORT_PRIORITY <include refid="fromdual"/>
	</select>
	<resultMap id="geActionAdditionalDetails" class="hmap">
		<result property="DETAIL_ID" javaType="long" />
		<result property="CODE" javaType="string" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="TYPE_CODE" javaType="string" />
	</resultMap>
	<select id="geActionAdditionalDetails" resultMap="geActionAdditionalDetails">
		select r.id,r.code,r.description,t.code from ptrlegal_additional_detail_ref r
		inner join ptrlegal_action_detail_rel d on d.additional_detail_id=r.id
		inner join ptradditional_detail_type_ref t on t.id=r.type_id
		where d.action_id=#ACTION_ID#
	</select>	
	<resultMap id="geActionProcessAdditionalDetails" class="hmap">
		<result property="ID" javaType="long" />
		<result property="DETAIL_ID" javaType="long" />
		<result property="CALENDAR" javaType="date" />
		<result property="TEXT" javaType="string" />
		<result property="PERCENTAGE" javaType="$" />
		<result property="AMOUNT" javaType="$" />
		<result property="NUMBER" javaType="$" />
		<result property="CHECKBOX" javaType="boolean" />
	</resultMap>
	<select id="geActionProcessAdditionalDetails" resultMap="geActionProcessAdditionalDetails">
		select id,detail_id,calendar,text,percentage,amount,number,checkbox 
		from ptrlegal_action_process_additional_details where
		process_id=#PROCESS_ID#
	</select>	

	<resultMap id="checkInstructionTermination" class="hmap">
		<result property="CLOSE_INSTRUCTION" javaType="boolean" />
		<result property="CLOSE_INSTRUCTION_STATUS_ID" javaType="long" />
		<result property="INITIATE_NEW_INSTRUCTION" javaType="boolean" />
		<result property="NEW_INSTRUCTION_ACTION_ID" javaType="long" />
		<result property="NEW_INSTRUCTION_STATUS_ID" javaType="long" />
	</resultMap>
	
	<select id="checkInstructionTermination" resultMap="checkInstructionTermination">
		SELECT TRUE AS CLOSE_INSTRUCTION,INSTRUCTION_STATUS_ID, 
		CASE WHEN T.NEW_INSTRUCTION_ID IS NOT NULL THEN TRUE END AS INITIATE_NEW_INSTRUCTION,
		T.NEW_INSTRUCTION_ID AS NEW_INSTRUCTION_ACTION_ID,
		CASE WHEN T.NEW_INSTRUCTION_ID IS NOT NULL THEN 15007 END AS NEW_INSTRUCTION_STATUS_ID
		FROM PTRLEGAL_ACTION_INSTRUCTION I 
		INNER JOIN ptrlegal_action_process P on P.id=i.process_id
		inner join PTRLEGAL_INSTRUCTION_TERMINATE_CONDITION T on t.instruction_id=p.action_id
		INNER JOIN PTRLEGAL_ACTION_REF R ON T.ACTION_ID=R.ID AND R.DISABLE = FALSE AND R.INSTRUCTION_ID=T.INSTRUCTION_ID
		WHERE i.process_id=#INSTRUCTION_PROCESS_ID# AND T.ACTION_ID= #ACTION_ID# AND T.ACTION_STATUS_ID =#STATUS_ID#
	</select>
	<resultMap id="getActionExpenseReference" class="hmap">
		<result property="EXPENSE_ID" javaType="long" />
		<result property="ACTION_ID" javaType="long" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="LIMIT_AMOUNT" javaType="$" />
		<result property="SST_PERCENT" javaType="$" />
	</resultMap>
	
	<select id="getActionExpenseReference" resultMap="getActionExpenseReference">
		SELECT ID,ACTION_ID,DESCRIPTION,LIMIT_AMOUNT,
		CASE WHEN SST = <include refid="true"/> THEN 0.06 ELSE 0 END AS SST_PERCENT 
		FROM PTRACTION_EXPENSES_REF
		where action_id=#ACTION_ID# and disable = <include refid="false"/>
	</select>
	<resultMap id="getActionSavedExpenses" class="hmap">
		<result property="EXPENSE_ID" javaType="long" />
		<result property="AMOUNT" javaType="$" />
		<result property="SST_AMOUNT" javaType="$" />
		<result property="FEE_AMOUNT" javaType="$" />
		<result property="REMARKS" javaType="string" />
	</resultMap>
	
	<select id="getActionSavedExpenses" resultMap="getActionSavedExpenses">
		SELECT EXPENSES_ID,AMOUNT,SST_AMOUNT,FEE_AMOUNT,REMARKS
		FROM PTRLEGAL_ACTION_EXPENSES
		WHERE PROCESS_ID=#PROCESS_ID#
	</select>	
	
	<resultMap id="getProcessDetails" class="hmap">
		<result property="STATUS_ID" javaType="long" />
		<result property="LAWYER_REFERENCE_NO" javaType="string" />
		<result property="CASE_NUMBER" javaType="string" />
		<result property="INSTITUTION_LEVEL_ID" javaType="long" />
		<result property="AUCTION_STATUS_ID" javaType="long" />
		<result property="CONTESTED_STATUS_ID" javaType="long" />
		<result property="DISBURSEMENT_AMOUNT" javaType="$" />
	</resultMap>
	<select id="getProcessDetails" resultMap="getProcessDetails">
		SELECT R.STATUS_ID,LAWYER_REFERENCE_NO,CASE_NUMBER,
		INSTITUTION_LEVEL_ID,AUCTION_STATUS_ID,CONTESTED_STATUS_ID,DISBURSEMENT_AMOUNT
		FROM PTRLEGAL_ACTION_PROCESS R
		WHERE ID=#PROCESS_ID#
	</select>
	<resultMap id="getActionDetails" class="hmap">
		<result property="HEADER_TITLE" javaType="string" />
		<result property="DISBURSEMENT" javaType="boolean" />
	</resultMap>
	<select id="getActionDetails" resultMap="getActionDetails">
		SELECT R.DESCRIPTION,R.DISBURSEMENT FROM PTRLEGAL_ACTION_REF R
		WHERE ID=#ACTION_ID#
	</select>
	<resultMap id="allowSaveInstruction" class="hmap">
		<result property="ALLOW_SAVE" javaType="boolean" />
	</resultMap>
	<select id="allowSaveInstruction" resultMap="allowSaveInstruction">
		SELECT DISTINCT CASE WHEN P.STATUS_ID IS NULL THEN <include refid="true"/> END ALLOW_SAVE
		FROM PTRACCOUNT_AGENCY_ASSIGNMENT AG
		LEFT JOIN PTRLEGAL_ACTION_PROCESS P ON AG.ID=P.AGENCY_ASSIGNMENT_ID  AND P.ACTION_ID = #ACTION_ID# AND P.STATUS_ID IN(15007,15004)
		LEFT JOIN PTRLEGAL_ACTION_INSTRUCTION I ON I.PROCESS_ID=P.ID
		WHERE AG.ID IN( <iterate property="ASSIGNMENT_IDS" conjunction=",">#ASSIGNMENT_IDS[]#</iterate>)
		ORDER BY ALLOW_SAVE DESC
	</select>
	

	<update id="terminateInstruction">
		UPDATE PTRLEGAL_ACTION_INSTRUCTION SET DISABLE =<include refid="true"/>
		WHERE PROCESS_ID=#INSTRUCTION_PROCESS_ID#
	</update>
	<update id="updateInstructionOnTerminate">
		UPDATE PTRLEGAL_ACTION_PROCESS SET STATUS_ID=#CLOSE_INSTRUCTION_STATUS_ID#,UPDATED_BY = #LOGON_USER#, UPDATED_TIME = #CURRENT_TIME#
		WHERE ID =#INSTRUCTION_PROCESS_ID#
	</update>	
	<insert id="insertInstruction">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRLEGAL_ACTION_PROCESS_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRLEGAL_ACTION_PROCESS(ID,ACTION_ID,AGENCY_ASSIGNMENT_ID,ACCOUNT_ID,STATUS_ID,CREATED_BY,CREATED_TIME)
		VALUES(#ID#,#ACTION_ID#,#AGENCY_ASSIGNMENT_ID#,#ACCOUNT_ID#,#STATUS_ID#,#LOGON_USER#,#CURRENT_TIME#)
	</insert>	
	<insert id="monitorInstruction">
		INSERT INTO PTRLEGAL_ACTION_INSTRUCTION(AGENCY_ASSIGNMENT_ID,PROCESS_ID)VALUES(#AGENCY_ASSIGNMENT_ID#,#PROCESS_ID#)
	</insert>	
	<insert id="insertActionExpenses">
		INSERT INTO PTRLEGAL_ACTION_EXPENSES(PROCESS_ID,EXPENSES_ID,AMOUNT,FEE_AMOUNT,SST_AMOUNT,REMARKS)
		VALUES(#PROCESS_ID#,#EXPENSE_ID#,#AMOUNT#,#FEE_AMOUNT#,#SST_AMOUNT#,#REMARKS#)	
	</insert>
	<delete id="clearActionExpenses">
		delete from PTRLEGAL_ACTION_EXPENSES where PROCESS_ID=#PROCESS_ID#
	</delete>
	
	<update id="updateAction">
		UPDATE PTRLEGAL_ACTION_PROCESS SET STATUS_ID=#STATUS_ID#,
		LAWYER_REFERENCE_NO =#LAWYER_REFERENCE_NO#,CASE_NUMBER =#CASE_NUMBER#,
		INSTITUTION_LEVEL_ID = #INSTITUTION_LEVEL_ID#, AUCTION_STATUS_ID = #AUCTION_STATUS_ID#, 
		CONTESTED_STATUS_ID = #CONTESTED_STATUS_ID#,DISBURSEMENT_AMOUNT = #DISBURSEMENT_AMOUNT#,
		UPDATED_BY = #LOGON_USER#, UPDATED_TIME = #CURRENT_TIME#
		WHERE ID =#PROCESS_ID#
	</update>
	
	<update id="updateAssignmentOnSuccessUpdate">
		update PTRACCOUNT_AGENCY_ASSIGNMENT set case_number=#CASE_NUMBER#
		where id=#AGENCY_ASSIGNMENT_ID#
	</update>
	
	<update id="updateAssignmentLastAction">
		update ptraccount_agency_assignment set LAST_PROCESS_ID=#PROCESS_ID#
		where id=#AGENCY_ASSIGNMENT_ID#
	</update>
		
	<insert id="insertAction">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRLEGAL_ACTION_PROCESS_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRLEGAL_ACTION_PROCESS(ID,ACTION_ID,AGENCY_ASSIGNMENT_ID,ACCOUNT_ID,
		STATUS_ID,INSTRUCTION_PROCESS_ID,LAWYER_REFERENCE_NO,CASE_NUMBER,
		INSTITUTION_LEVEL_ID,AUCTION_STATUS_ID,CONTESTED_STATUS_ID,DISBURSEMENT_AMOUNT,
		CREATED_BY,CREATED_TIME)
		VALUES(#ID#,#ACTION_ID#,#AGENCY_ASSIGNMENT_ID#,#ACCOUNT_ID#,#STATUS_ID#,
		#INSTRUCTION_PROCESS_ID#,#LAWYER_REFERENCE_NO#,#CASE_NUMBER#,
		#INSTITUTION_LEVEL_ID#,#AUCTION_STATUS_ID#,#CONTESTED_STATUS_ID#,#DISBURSEMENT_AMOUNT#,
		#LOGON_USER#,#CURRENT_TIME#)
	</insert>
	<update id="proceedBillingOnInstructionClosed">
		update PTRLEGAL_ACTION_COMMISION set proceed=<include refid="true"/>
		where process_id in(select process_id from ptrlegal_action_process where instruction_process_id=#INSTRUCTION_PROCESS_ID#)	
	</update>
	<resultMap id="getActionRemarkHistory" class="hmap">
		<result property="REMARKS" javaType="string" />
		<result property="UPDATE_TIME" javaType="date" />
	</resultMap>
	<select id="getActionRemarkHistory" resultMap="getActionRemarkHistory">
		SELECT REMARKS,UPDATE_TIME FROM PTRLEGAL_ACTION_REMARKS
		WHERE PROCESS_ID=#PROCESS_ID#
	</select>	
	<insert id="insertFollowUp">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRLEGAL_ACTION_PROCESS_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRLEGAL_ACTION_PROCESS(ID,ACTION_ID,AGENCY_ASSIGNMENT_ID,ACCOUNT_ID,STATUS_ID,CREATED_BY,CREATED_TIME)
		VALUES(#ID#,#ACTION_ID#,#AGENCY_ASSIGNMENT_ID#,#ACCOUNT_ID#,#STATUS_ID#,#LOGON_USER#,#CURRENT_TIME#)
	</insert>
	<insert id="insertSpecialAction">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRLEGAL_ACTION_PROCESS_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRLEGAL_ACTION_PROCESS(ID,ACTION_ID,AGENCY_ASSIGNMENT_ID,ACCOUNT_ID,STATUS_ID,CREATED_BY,CREATED_TIME)
		VALUES(#ID#,#ACTION_ID#,#AGENCY_ASSIGNMENT_ID#,#ACCOUNT_ID#,#STATUS_ID#,#LOGON_USER#,#CURRENT_TIME#)
	</insert>
	<insert id="insertRemedialAction">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRLEGAL_ACTION_PROCESS_ID
			<include refid="sequenceSuffix" />
		</selectKey>	
		INSERT INTO PTRLEGAL_ACTION_PROCESS(ID,ACTION_ID,AGENCY_ASSIGNMENT_ID,ACCOUNT_ID,STATUS_ID,CREATED_BY,CREATED_TIME)
		VALUES(#ID#,#ACTION_ID#,#AGENCY_ASSIGNMENT_ID#,#ACCOUNT_ID#,#STATUS_ID#,#LOGON_USER#,#CURRENT_TIME#)
	</insert>


	<update id="updateFollowUp">
		UPDATE PTRLEGAL_ACTION_PROCESS SET STATUS_ID=#STATUS_ID#,UPDATED_BY = #LOGON_USER#, UPDATED_TIME = #CURRENT_TIME#
		WHERE ID =#PROCESS_ID#
	</update>
	<update id="updateSpecialAction">
		UPDATE PTRLEGAL_ACTION_PROCESS SET STATUS_ID=#STATUS_ID#,UPDATED_BY = #LOGON_USER#, UPDATED_TIME = #CURRENT_TIME#
		WHERE ID =#PROCESS_ID#
	</update>
	<update id="updateRemedialAction">
		UPDATE PTRLEGAL_ACTION_PROCESS SET STATUS_ID=#STATUS_ID#,UPDATED_BY = #LOGON_USER#, UPDATED_TIME = #CURRENT_TIME#
		WHERE ID =#PROCESS_ID#
	</update>

	<update id="updateInstruction">
		UPDATE PTRLEGAL_ACTION_PROCESS SET STATUS_ID=#STATUS_ID#,UPDATED_BY = #LOGON_USER#, UPDATED_TIME = #CURRENT_TIME#
		WHERE ID =#PROCESS_ID#
	</update>
	<update id="updateInstructionLatestAction">
		UPDATE PTRLEGAL_ACTION_INSTRUCTION SET LATEST_ACTION_PROCESS_ID = #PROCESS_ID# 
		WHERE PROCESS_ID=#INSTRUCTION_PROCESS_ID#
	</update>
	<insert id="insertLegalActionRemarks">
		INSERT INTO PTRLEGAL_ACTION_REMARKS (PROCESS_ID,REMARKS,USER_ID,UPDATE_TIME)
		VALUES(#PROCESS_ID#,#REMARKS#,#LOGON_USER#,#CURRENT_TIME#)	
	</insert>
	<insert id="monitorFollowUp">
		INSERT INTO PTRLEGAL_ACTION_FOLLOW_UP(AGENCY_ASSIGNMENT_ID,PROCESS_ID)	VALUES(#AGENCY_ASSIGNMENT_ID#,#PROCESS_ID#)
	</insert>
	<insert id="monitorSpecialAction">
		INSERT INTO PTRLEGAL_IN_PROGRESS_SPECIAL_ACTION(AGENCY_ASSIGNMENT_ID,PROCESS_ID)	VALUES(#AGENCY_ASSIGNMENT_ID#,#PROCESS_ID#)
	</insert>
	<insert id="monitorRemedialAction">
		INSERT INTO PTRLEGAL_IN_PROGRESS_REMEDIAL_ACTION(AGENCY_ASSIGNMENT_ID,PROCESS_ID)	VALUES(#AGENCY_ASSIGNMENT_ID#,#PROCESS_ID#)
	</insert>
	<insert id="monitorInProgressAction">
		INSERT INTO PTRLEGAL_IN_PROGRESS_ACTION(AGENCY_ASSIGNMENT_ID,PROCESS_ID)	VALUES(#AGENCY_ASSIGNMENT_ID#,#PROCESS_ID#)
	</insert>
	<delete id="clearFollowUp">
		delete from PTRLEGAL_ACTION_FOLLOW_UP WHERE PROCESS_ID = #PROCESS_ID#
	</delete>
	<delete id="clearSpecialAction">
		delete from PTRLEGAL_IN_PROGRESS_SPECIAL_ACTION WHERE PROCESS_ID = #PROCESS_ID#
	</delete>
	<delete id="clearRemedialAction">
		delete from PTRLEGAL_IN_PROGRESS_REMEDIAL_ACTION WHERE PROCESS_ID = #PROCESS_ID#
	</delete>
	<delete id="clearInProgressAction">
		delete from PTRLEGAL_IN_PROGRESS_ACTION WHERE PROCESS_ID = #PROCESS_ID#
	</delete>

	<update id="closeInstruction">
		UPDATE PTRLEGAL_ACTION_INSTRUCTION SET DISABLE =<include refid="true"/>
		WHERE PROCESS_ID=#PROCESS_ID#
	</update>
	
	<resultMap class="hmap" id="getContractAgencySubType">
	<result property="SUBTYPE" javaType="string"/>
	</resultMap>
	
	<select id="getContractAgencySubType" resultMap="getContractAgencySubType">
	select CODE from PTRTREATMENT_SUBTYPE_REF where ID=#SUBTYPE_ID#
	</select>
	<resultMap class="hmap" id="getContractTermForEvaluation">
	<result property="TERM_ID" javaType="long"/>
	<result property="VERSION_ID" javaType="long"/>
	<result property="DOCUMENT_ID" javaType="long"/>
	</resultMap>
	
	<select id="getContractTermForEvaluation" resultMap="getContractTermForEvaluation">
		select t.id,t.version_id,t.document_id from ptraccount_agency_assignment ag
		inner join ptragency_contract_version v on v.contract_id=ag.contract_id
		inner JOIN ptragency_contract_version_term t on t.version_id=v.id
		where ag.id=#AGENCY_ASSIGNMENT_ID# and v.id=(select max(vv.id) from ptragency_contract_version vv 
		where vv.contract_id=v.contract_id and vv.effective_date &lt;=#CURRENT_TIME#)
	</select>
	<insert id="insertLegalActionCommission">
		INSERT INTO PTRLEGAL_ACTION_COMMISION(PROCESS_ID,TERM_ID,VERSION_ID,ACTION_ID,STATUS_ID,COMMISION_AMOUNT)
		VALUES(#PROCESS_ID#,#TERM_ID#,#VERSION_ID#,#ACTION_ID#,#STATUS_ID#,#COMMISSION_AMOUNT#)	
	</insert>
	<resultMap class="hmap" id="getContractTermForEvaluationOnInstructionTermination">
		<result property="TERM_ID" javaType="long"/>
		<result property="VERSION_ID" javaType="long"/>
		<result property="DOCUMENT_ID" javaType="long"/>
		<result property="PROCESS_ID" javaType="long"/>
		<result property="ACTION_ID" javaType="long"/>
		<result property="STATUS_ID" javaType="long"/>
		<result property="AGENCY_ASSIGNMENT_ID" javaType="long"/>
		<result property="AUCTION_STATUS_ID" javaType="long"/>
		<result property="INSTITUTION_ID" javaType="long"/>
		<result property="CONTESTED_STATUS_ID" javaType="long"/>
		<result property="SST_PERCENT" javaType="$"/>
	</resultMap>
	
	<select id="getContractTermForEvaluationOnInstructionTermination" resultMap="getContractTermForEvaluationOnInstructionTermination">
		select t.id,t.version_id,t.document_id,p.id as process_id,
		p.action_id as action_id,p.status_id,p.agency_assignment_id, 
		null as auction_status_id,null as institution_id,null as contested_status_id,case when sst = true then 0.06 else 0 end as SST_PERCENT 
		from ptraccount_agency_assignment ag
		inner join ptrlegal_action_process p on p.agency_assignment_id=ag.id and p.id=#INSTRUCTION_PROCESS_ID#
		inner join ptrlegal_action_ref r on r.id=p.action_id
		inner join ptragency_contract_version v on v.contract_id=ag.contract_id
		inner JOIN ptragency_contract_version_term t on t.version_id=v.id
		where ag.id=#AGENCY_ASSIGNMENT_ID# and v.id=(select max(vv.id) from ptragency_contract_version vv 
		where vv.contract_id=v.contract_id and vv.effective_date &lt;=#CURRENT_TIME#)
	</select>
	<update id="setTransactionToProceed">
		update PTRLEGAL_ACTION_PROCESS set proceed = true
		where instruction_process_id=#INSTRUCTION_PROCESS_ID# or id =#INSTRUCTION_PROCESS_ID#
	</update>	
	<update id="updateAgencyAssignmentLatestInstruction">
		UPDATE PTRACCOUNT_AGENCY_ASSIGNMENT SET LAST_INSTRUCTION_ID = #ACTION_ID# 
		WHERE ID=#AGENCY_ASSIGNMENT_ID#
	</update>
</sqlMap>