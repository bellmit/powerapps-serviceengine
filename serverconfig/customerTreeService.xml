<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="customerTreeService">

	<resultMap class="hmap" id="getCurrentUserType">
		<result property="AGENCY_ID" javaType="string" />
		<result property="USER_TYPE_ID" javaType="string" />
	</resultMap>
	<select id="getCurrentUserType" resultMap="getCurrentUserType">
		SELECT AGENCY_ID , USER_TYPE_ID FROM ptruser where USER_ID = #CURRENT_USER#
	</select>
	
	<resultMap id="getCustomerForTree" class="java.util.HashMap">
		<result property="CUSTOMER_ID" javaType="long"/>
		<result property="PRODUCT_CATEGORY_CODE" javaType="string"/>
		<result property="PRODUCT_TYPE_DESCRIPTION" javaType="string"/>
		<result property="CUSTOMER_NAME" javaType="string"/>
  </resultMap>
    <select id="getCustomerForTree" resultMap="getCustomerForTree" parameterClass="map">
		SELECT A.CUSTOMER_ID,PC.CODE,
		UPPER(P.CODE||' '||P.DESCRIPTION),
		COALESCE(C.CUSTOMER_NAME,C.CUSTOMER_NO),
		COALESCE(C.CUSTOMER_NAME,C.CUSTOMER_NO)
		FROM PTRCUSTOMER C 
		INNER JOIN PTRACCOUNT A ON C.id=cast(A.CUSTOMER_ID as BIGINT)
		INNER JOIN PTRPRODUCT_TYPE_REF P ON A.PRODUCT_TYPE_ID = P.ID
		INNER JOIN PTRPRODUCT_TYPE_CATEGORY_REF PC ON P.CATEGORY_ID = PC.ID
		WHERE c.ID = cast(#CUSTOMER_ID# as BIGINT)
		<isEqual property="USER_TYPE_ID" compareValue="2">
		AND EXISTS(SELECT 1 FROM PTRACCOUNT_AGENCY_ASSIGNMENT AG 
		INNER JOIN PTRAGENCY_EFFECTIVE_ASSIGNMENT E ON E.AGENCY_ASSIGNMENT_ID=AG.ID 
		inner join ptragency_effective_assignment eff on eff.agency_assignment_id=ag.id
		WHERE AG.ACCOUNT_ID=A.ID AND AG.STATUS_ID = 15007 and E.EFFECTIVE_DATE &lt;= #CURRENT_DATE#)
		</isEqual>
	</select>
	<resultMap id="getCustomerAccountsForTree" class="java.util.HashMap">
		<result property="ACCOUNT_ID" javaType="long"/>
		<result property="CUSTOMER_ID" javaType="long"/>
		<result property="ACCOUNT_NUMBER" javaType="string"/>
		<result property="PRODUCT_CATEGORY_CODE" javaType="string"/>
		<result property="PRODUCT_TYPE_DESCRIPTION" javaType="string"/>
		<result property="SPTF_FLAG" javaType="boolean"/>
		<result property="DELINQUENT_STATUS" javaType="string"/>
		<result property="STATUS_CODE" javaType="string"/>
  </resultMap>
    <select id="getCustomerAccountsForTree" resultMap="getCustomerAccountsForTree" parameterClass="map">
		SELECT A.ID,A.CUSTOMER_ID,A.ACCOUNT_NO,PC.CODE,
		UPPER(P.CODE ||' '||P.DESCRIPTION),
		SPTF.IS_ISLAMIC AS SPTF_FLAG,
		CASE WHEN (A.months_in_arrears = 0 OR A.months_in_arrears IS NULL) THEN 'NOT DELINQUENT'
		WHEN A.months_in_arrears BETWEEN 1 AND 1 THEN 'ALMOST DELINQUENT' ELSE 'DELINQUENT' END AS DELINQUENT_STATUS,
		s.CODE 
		FROM PTRCUSTOMER C 
		INNER JOIN PTRACCOUNT A ON cast(A.CUSTOMER_ID as BIGINT)=C.ID
		INNER join ptraccount_status_ref s on s.id=a.status_id
		INNER JOIN PTRPRODUCT_TYPE_REF P ON A.PRODUCT_TYPE_ID=P.id
		INNER JOIN PTRPRODUCT_TYPE_CATEGORY_REF PC ON P.category_id = PC.id
		LEFT JOIN PTRSPTF_TYPE_REF SPTF ON SPTF.ID = A.SPTF_TYPE_ID
		WHERE c.ID = cast(#CUSTOMER_ID# as BIGINT)
		and p.disable != true
		<isEqual property="USER_TYPE_ID" compareValue="2">
		AND EXISTS(SELECT 1 FROM PTRACCOUNT_AGENCY_ASSIGNMENT AG 
		INNER JOIN PTRAGENCY_EFFECTIVE_ASSIGNMENT E ON E.AGENCY_ASSIGNMENT_ID=AG.ID AND E.EFFECTIVE_DATE &lt;= #CURRENT_DATE#
		WHERE AG.ACCOUNT_ID=A.ID AND AG.STATUS_ID = 15007)
		</isEqual>
	</select>	
</sqlMap>