<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="agencySetupService">

	<select id="getECAAgencyTypeForSetup" resultMap="global.ref">
		<include refid="refselect" /> 
		from ptragency_type_ref
		where CODE='ECA'
	</select>
	<select id="getLegaAgencyTypeForSetup" resultMap="global.ref">
		<include refid="refselect" /> 
		from ptragency_type_ref
		where CODE !='ECA'
	</select>
	<select id="getECAAgencySubtypeForSetup" resultMap="global.ref">
		<include refid="refselect" /> 
		from ptragency_subtype_ref
	</select>
	<select id="getECACountriesForSetup" resultMap="global.ref">
		<include refid="refselect" /> 
		from ptrcountry_ref
	</select>	
	<select id="getECARegionsForSetup" resultMap="global.ref">
		<include refid="refselect" /> 
		from ptrregion_ref
	</select>
	<resultMap id="getAgencyTypes" class="hmap"
		extends="global.ref">
		<result property="LOAD_AGENCIES" javaType="boolean" />
	</resultMap>
	<select id="getAgencyTypes" resultMap="getAgencyTypes">
		<include refid="selectAllRef" />
		,
		<include refid="true" />
		<include refid="fromdual" />
		union
		<include refid="refselect" />
		,
		<include refid="true" />
		from ptragency_type_ref
	</select>
	<select id="getAgencyTypesForEditing" resultMap="global.ref">
		<include refid="pleaseSelectRef" />
		union
		<include refid="refselect" />
		from ptragency_type_ref
	</select>
	<select id="getAgencyStatusForEditing" resultMap="global.ref">
		<include refid="pleaseSelectRef" />
		union
		<include refid="refselect" />
		from ptragency_status_ref
	</select>
	<select id="getGenerationDays" resultMap="global.ref">
		<include refid="pleaseSelectRef" />
	</select>
	<select id="getAgencyStatesForEditing" resultMap="global.ref">
		<include refid="pleaseSelectRef" />
		union
		<include refid="refselect" />
		from ptrstate_ref
	</select>
	<insert id="insertAgency" parameterClass="map">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRAGENCY_ID
			<include refid="sequenceSuffix" />
		</selectKey>
		INSERT INTO PTRAGENCY
		(ID,CODE,DESCRIPTION,TYPE_ID,STATUS_ID,REMARKS,REGISTRATION_NUMBER,
		EMAIL,PHONE_NO,FAX_NO,ADDRESS_1,ADDRESS_2,ADDRESS_3,ADDRESS_4,ADDRESS_5,CITY,POSTAL_CODE,
		STATE_ID,INVOICE_GENERATION_DAY,CREATED_BY,CREATED_TIME,SORT_PRIORITY)
		VALUES
		(#ID#,#CODE#,#DESCRIPTION#,#TYPE_ID#,#STATUS_ID#,#REMARKS#,#REGISTRATION_NUMBER#,
		#EMAIL#,#PHONE_NO#,#FAX_NO#,#ADDRESS_1#,#ADDRESS_2#,#ADDRESS_3#,#ADDRESS_4#,#ADDRESS_5#,#CITY#,#POSTAL_CODE#,
		#STATE_ID#,#INVOICE_GENERATION_DAY#,#LOGON_USER#,#CURRENT_TIME#,#ID#)
	</insert>
	<update id="updateAgency" parameterClass="map">
		UPDATE PTRAGENCY SET
		CODE = #CODE#,
		DESCRIPTION = #DESCRIPTION#,
		STATUS_ID = #STATUS_ID#,
		REMARKS = #REMARKS#,
		REGISTRATION_NUMBER = #REGISTRATION_NUMBER#,
		EMAIL
		= #EMAIL#,
		PHONE_NO = #PHONE_NO#,
		FAX_NO = #FAX_NO#,
		ADDRESS_1 =
		#ADDRESS_1#,
		ADDRESS_2 = #ADDRESS_2#,
		ADDRESS_3 = #ADDRESS_3#,
		ADDRESS_4
		= #ADDRESS_4#,
		ADDRESS_5 = #ADDRESS_5#,
		CITY = #CITY#,
		POSTAL_CODE =
		#POSTAL_CODE#,
		STATE_ID = #STATE_ID# ,
		INVOICE_GENERATION_DAY = #INVOICE_GENERATION_DAY#,
		UPDATED_BY = #LOGON_USER#,
		UPDATED_TIME =
		#CURRENT_TIME#
		WHERE ID = #AGENCY_ID#
	</update>

	<resultMap id="getAgencyList" class="hmap">
		<result property="AGENCY_ID" javaType="long" />
		<result property="CODE" javaType="string" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="TYPE" javaType="string" />
		<result property="STATUS" javaType="string" />
		<result property="REMARKS" javaType="string" />
		<result property="REGISTRATION_NUMBER" javaType="string" />
		<result property="EMAIL" javaType="string" />
		<result property="CONTACT_NUMBER" javaType="string" />
		<result property="FAX_NO" javaType="string" />
		<result property="ADDRESS_1" javaType="string" />
		<result property="ADDRESS_2" javaType="string" />
		<result property="ADDRESS_3" javaType="string" />
		<result property="CITY" javaType="string" />
		<result property="POSTAL_CODE" javaType="string" />
		<result property="STATE" javaType="string" />
		<result property="INVOICE_GENERATION_DAY" javaType="long" />
		<result property="DISABLE" javaType="boolean" />
		<result property="CREATED_TIME" javaType="ts" />
		<result property="CREATED_BY" javaType="string" />
		<result property="UPDATED_TIME" javaType="ts" />
		<result property="UPDATED_BY" javaType="string" />
		<result property="SUBTYPE" javaType="string" />
		<result property="AGENCY_NAME" javaType="string" />
		<result property="COMPANY_NO" javaType="string" />
		<result property="REGION" javaType="string" />
		<result property="REGISTERED_ADDRESS" javaType="string" />
		<result property="ACTIVE" javaType="boolean" />
		<result property="SUBTYPE" javaType="string" />
	</resultMap>
	<select id="getAgencyList" resultMap="getAgencyList">
		SELECT G.ID,G.CODE,G.DESCRIPTION,
		R.DESCRIPTION AS TYPE,SR.DESCRIPTION
		AS STATUS,
		G.REMARKS,G.REGISTRATION_NUMBER,G.EMAIL,
		G.PHONE_NO,G.FAX_NO,G.ADDRESS_1,G.ADDRESS_2,
		G.ADDRESS_3,G.CITY,G.POSTAL_CODE,S.DESCRIPTION AS STATE,
		G.INVOICE_GENERATION_DAY,G.DISABLE,
		G.CREATED_TIME,G.CREATED_BY,G.UPDATED_TIME,
		G.UPDATED_BY,NULL AS
		SUBTYPE,G.DESCRIPTION,
		G.COMPANY_NO,RE.DESCRIPTION,G.REGISTRATION_ADDRESS AS
		REGISTERED_ADDRESS,
		NULL AS ACTIVE,
		SUB.DESCRIPTION AS SUBTYPE
		FROM PTRAGENCY G
		LEFT JOIN PTRSTATE_REF S ON S.ID=G.STATE_ID
		LEFT JOIN	PTRAGENCY_TYPE_REF R ON R.ID=G.TYPE_ID
		INNER JOIN PTRAGENCY_STATUS_REF SR ON SR.ID=G.STATUS_ID
		LEFT JOIN PTRREGION_REF RE ON RE.ID=G.REGION_ID
		LEFT JOIN PTRAGENCY_SUBTYPE_REF SUB ON SUB.ID=G.AGENCY_SUBTYPE_ID
		where 1=1
		<isNotEqual property="INCLUDE_ALL" compareValue="true">
			and G.DISABLE =
			<include refid="false" />
		</isNotEqual>
		<isNotEmpty property="AGENCY_NAME">
			and upper(G.DESCRIPTION) like '%'||upper(#AGENCY_NAME#)||'%'
		</isNotEmpty>
		<isNotNull property="AGENCY_TYPE_ID">
			and G.TYPE_ID = #AGENCY_TYPE_ID#
		</isNotNull>
		<isNotNull property="TYPE_ID">
			and G.TYPE_ID = #TYPE_ID#
		</isNotNull>
	</select>
	<resultMap id="getAgencyForEditing" class="hmap">
		<result property="CODE" javaType="string" />
		<result property="DESCRIPTION" javaType="string" />
		<result property="TYPE_ID" javaType="long" />
		<result property="STATUS_ID" javaType="long" />
		<result property="COUNTRY_ID" javaType="long" />
		<result property="INVOICE_GENERATION_DAY" javaType="long" />
		<result property="STATE_ID" javaType="long" />
		<result property="REGISTRATION_NUMBER" javaType="string" />
		<result property="EMAIL" javaType="string" />
		<result property="CONTACT_NUMBER" javaType="string" />
		<result property="FAX_NO" javaType="string" />
		<result property="REMARKS" javaType="string" />
		<result property="ADDRESS_1" javaType="string" />
		<result property="ADDRESS_2" javaType="string" />
		<result property="ADDRESS_3" javaType="string" />
		<result property="ADDRESS_4" javaType="string" />
		<result property="ADDRESS_5" javaType="string" />
		<result property="CITY" javaType="string" />
		<result property="POSTAL_CODE" javaType="string" />
		<result property="REGION_ID" javaType="long" />
		<result property="GST_REGISTRATION_NO" javaType="string" />
		<result property="PARTNER_1" javaType="string" />
		<result property="PARTNER_2" javaType="string" />
		<result property="PARTNER_3" javaType="string" />
		<result property="PARTNER_4" javaType="string" />
		<result property="PARTNER_5" javaType="string" />
		<result property="PARTNER_6" javaType="string" />
		<result property="PARTNER_7" javaType="string" />
		<result property="PARTNER_8" javaType="string" />
		<result property="BANK_ACCOUNT_NO" javaType="string" />
		<result property="BANK_NAME" javaType="string" />
		<result property="REGISTRATION_ADDRESS" javaType="string" />
		<result property="COMPANY_NUMBER" javaType="string" />
		<result property="DISABLE" javaType="boolean" />
		<result property="SUBTYPE_ID" javaType="long" />
		<result property="LOCATION_ID" javaType="long" />
		<result property="AREA_ID" javaType="long" />
		<result property="BANK_COORDINATOR" javaType="string" />
		<result property="FROM_HOST" javaType="boolean"/>
		<result property="STATUS_DATE" javaType="date"/>
		<result property="PHONE_NO" javaType="string"/>
		<result property="CONTACT_PERSON" javaType="string"/>
		<result property="SST_REGISTRATION_NO" javaType="string"/>
		<result property="SST_RATE" javaType="double"/>
	</resultMap>
	<select id="getAgencyForEditing" resultMap="getAgencyForEditing">
		select CODE,DESCRIPTION,TYPE_ID,STATUS_ID,COUNTRY_ID,INVOICE_GENERATION_DAY,STATE_ID,
		REGISTRATION_NUMBER,EMAIL,PHONE_NO,FAX_NO,REMARKS,ADDRESS_1,ADDRESS_2,
		ADDRESS_3,ADDRESS_4,ADDRESS_5,CITY,POSTAL_CODE,REGION_ID,
		GST_REGISTRATION_NO,PARTNER_1,PARTNER_2,PARTNER_3,PARTNER_4,
		PARTNER_5,PARTNER_6,PARTNER_7,PARTNER_8,BANK_ACCOUNT_NO,BANK_NAME,
		REGISTRATION_ADDRESS,COMPANY_NO,DISABLE,AGENCY_SUBTYPE_ID,
		LOCATION_ID,AREA_ID,BANK_COORDINATOR,FROM_HOST,STATUS_DATE,
		PHONE_NO,CONTACT_PERSON,SST_REGISTRATION_NO,SST_RATE
		FROM PTRAGENCY WHERE ID = #AGENCY_ID#
	</select>
	<insert id="insertEcaAgency" parameterClass="map">
		<selectKey keyProperty="ID" resultClass="long">
			<include refid="sequencePrefix" />
			PTRAGENCY_ID
			<include refid="sequenceSuffix" />
		</selectKey>
		INSERT INTO PTRAGENCY
		(ID,CODE,DESCRIPTION,TYPE_ID,STATUS_ID,REMARKS,REGISTRATION_NUMBER,
		EMAIL,PHONE_NO,FAX_NO,ADDRESS_1,ADDRESS_2,ADDRESS_3,ADDRESS_4,ADDRESS_5,CITY,POSTAL_CODE,
		STATE_ID,INVOICE_GENERATION_DAY,CREATED_BY,CREATED_TIME,SORT_PRIORITY,
		REGION_ID,GST_REGISTRATION_NO,PARTNER_1,PARTNER_2,PARTNER_3,
		PARTNER_4,PARTNER_5,PARTNER_6,PARTNER_7,PARTNER_8,
		BANK_ACCOUNT_NO,BANK_NAME,REGISTRATION_ADDRESS,COMPANY_NO,AGENCY_SUBTYPE_ID,
		LOCATION_ID,AREA_ID,FROM_HOST,DISABLE,BANK_COORDINATOR,STATUS_DATE,COUNTRY_ID,
		CONTACT_PERSON,SST_REGISTRATION_NO,SST_RATE)
		VALUES
		(#ID#,#CODE#,#DESCRIPTION#,#TYPE_ID#,#STATUS_ID#,#REMARKS#,#REGISTRATION_NUMBER#,
		#EMAIL#,#CONTACT_NUMBER#,#FAX_NO#,#ADDRESS_1#,#ADDRESS_2#,#ADDRESS_3#,#ADDRESS_4#,#ADDRESS_5#,#CITY#,#POSTAL_CODE#,
		#STATE_ID#,#INVOICE_GENERATION_DAY#,#LOGON_USER#,#CURRENT_TIME#,#ID#,
		#REGION_ID#,#GST_REGISTRATION_NO#,#PARTNER_1#,#PARTNER_2#,#PARTNER_3#,
		#PARTNER_4#,#PARTNER_5#,#PARTNER_6#,#PARTNER_7#,#PARTNER_8#,
		#BANK_ACCOUNT_NO#,#BANK_NAME#,#REGISTRATION_ADDRESS#,#COMPANY_NUMBER#,#SUBTYPE_ID#,
		#LOCATION_ID#,#AREA_ID#,COALESCE(#FROM_HOST#,false),COALESCE(#DISABLE#,false),#BANK_COORDINATOR#,#CURRENT_TIME#,#COUNTRY_ID#,
		#CONTACT_PERSON#,#SST_REGISTRATION_NO#,#SST_RATE#)
	</insert>
	<update id="updateEcaAgency" parameterClass="map">
		UPDATE PTRAGENCY SET
		CODE = #CODE#,
		DESCRIPTION = #DESCRIPTION#,
		STATUS_ID = #STATUS_ID#,
		REMARKS = #REMARKS#,
		REGISTRATION_NUMBER = #REGISTRATION_NUMBER#,
		EMAIL = #EMAIL#,
		PHONE_NO = #CONTACT_NUMBER#,
		FAX_NO = #FAX_NO#,
		ADDRESS_1 =	#ADDRESS_1#,
		ADDRESS_2 = #ADDRESS_2#,
		ADDRESS_3 = #ADDRESS_3#,
		CITY = #CITY#,
		POSTAL_CODE = #POSTAL_CODE#,
		STATE_ID = #STATE_ID# ,
		INVOICE_GENERATION_DAY = #INVOICE_GENERATION_DAY#,
		UPDATED_BY = #LOGON_USER#,
		UPDATED_TIME =#CURRENT_TIME#,
		REGION_ID = #REGION_ID#,
		COUNTRY_ID = #COUNTRY_ID#,
		GST_REGISTRATION_NO = #GST_REGISTRATION_NO#,
		PARTNER_1 = #PARTNER_1#,
		PARTNER_2 = #PARTNER_2#,
		PARTNER_3 = #PARTNER_3#,
		PARTNER_4 = #PARTNER_4#,
		PARTNER_5 =	#PARTNER_5#,
		PARTNER_6 = #PARTNER_6#,
		PARTNER_7 = #PARTNER_7#,
		PARTNER_8 = #PARTNER_8#,
		BANK_ACCOUNT_NO = #BANK_ACCOUNT_NO#,
		BANK_NAME =	#BANK_NAME#,
		REGISTRATION_ADDRESS = #REGISTRATION_ADDRESS#,
		COMPANY_NO = #COMPANY_NUMBER#,
		DISABLE = #DISABLE#,
		AGENCY_SUBTYPE_ID = #SUBTYPE_ID#,
		LOCATION_ID=#LOCATION_ID#,
		AREA_ID=#AREA_ID#,
		FROM_HOST=COALESCE(#FROM_HOST#,false),
		BANK_COORDINATOR=#BANK_COORDINATOR#,
		STATUS_DATE=case when STATUS_ID != #STATUS_ID# then #CURRENT_TIME# else STATUS_DATE end,
		CONTACT_PERSON = #CONTACT_PERSON#,
		SST_REGISTRATION_NO = #SST_REGISTRATION_NO#,
		SST_RATE = #SST_RATE#
		WHERE ID = #AGENCY_ID#
	</update>
	<resultMap id="getAgencyUsers" class="hmap">
		<result property="USER_ID" javaType="string" />
		<result property="CREATED_DATE" javaType="date" />
		<result property="LOGON_STATUS" javaType="boolean" />
		<result property="ACTVE_STATUS" javaType="boolean" />
		<result property="PASSWORD_EXPIRY_DATE" javaType="date" />
		<result property="USER_EXPIRY_DATE" javaType="date" />
		<result property="EMPLOYEE_ID" javaType="string" />
		<result property="EMAIL" javaType="string" />
	</resultMap>
	<select id="getAgencyUsers" resultMap="getAgencyUsers">
		select u.user_id,u.create_date,case when u.logon_status = 'T' then <include refid="true"/> else <include refid="false"/> end as LOGON_STATUS,
		case when u.active_status ='Y' then  <include refid="true"/> else <include refid="false"/> end as ACTVE_STATUS,
		u.passwd_exp_date,u.user_exp_date,e.employee_no,e.email_address
		from ptruser u 
		inner join ptremployee e on e.id=u.employee_id
		where u.agency_id=#AGENCY_ID#
	</select>	
	<resultMap class="hmap" id="getECABankCoordinator">
	<result property="ID" javaType="string"/>
	<result property="DESCRIPTION" javaType="string"/>
	<result property="DISABLE" javaType="boolean"/>
	<result property="SORT_PRIORITY" javaType="long"/>
	</resultMap>
	
	<select id="getECABankCoordinator" resultMap="getECABankCoordinator">
	select NULL, <include refid="pleaseSelectText"/>, false, -1 <include refid="fromdual"/>
	union
	select u.user_id, u.user_id, u.disable, 1 from ptruser u
		inner join ptremployee e on e.id=u.employee_id
		inner join ptremployee_position_ref p on p.id=e.position_id
		where p.code='AC' and (u.user_type_id is null or u.user_type_id=1)
		and e.disable=false
	</select>	
	
	
	<insert id="insertAgencyInvoiceDayHistory" parameterClass="map">
	insert into PTRAGENCY_INVOICE_DAY_HISTORY
	(AGENCY_ID,INVOICE_DAY,UPDATE_TIME)
	values (#AGENCY_ID#, #INVOICE_GENERATION_DAY#, #CURRENT_TIME#)
	</insert>
	
	
</sqlMap>