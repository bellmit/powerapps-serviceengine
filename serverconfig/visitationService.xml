<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="visitationService">

<insert id="insertTreatmentVisitation" parameterClass="map">
insert into PTRTREATMENT_VISITATION(
TREATMENT_ID,ACCOUNT_ID,TYPE_STATUS_ID,SUBTYPE_ID,CONTACT_ID,
VISITATION_TO_ID,TEMPLATE_VERSION_ID,TURNAROUND_TIME,AREA_ID,
STATE_ID,PURPOSE_VISIT_ID,EXPECTED_VISITATION_DATE,RESIDENT_RACE_ID,
FAMILY_MEMBERS_NO,LOCATION,HOUSE_OUTLOOK,HOUSE_TYPE,HOUSE_INTERIOR,
MBSB_CAR,OTHER_VEHICLES,RESULT_COME_BACK_DATE,VISITATION_STAFF_NAME,
DOCUMENT_ID_1,DOCUMENT_ID_2,VISITATION_PURPOSE_ID,VISITATION_USER_ID)
values
(#ID#,#ACCOUNT_ID#,#TYPE_STATUS_ID#,#SUBTYPE_ID#,#CONTACT_ID#,
#VISITATION_TO_ID#,#TEMPLATE_VERSION_ID#,#TURNAROUND_TIME#,#AREA_ID#,
#STATE_ID#,#PURPOSE_VISIT_ID#,#EXPECTED_VISITATION_DATE#,#RESIDENT_RACE_ID#,
#FAMILY_MEMBERS_NO#,#LOCATION#,#HOUSE_OUTLOOK#,#HOUSE_TYPE#,#HOUSE_INTERIOR#,
#MBSB_CAR#,#OTHER_VEHICLES#,#RESULT_COME_BACK_DATE#,#VISITATION_STAFF_NAME#,
#DOCUMENT_ID_1#,#DOCUMENT_ID_2#,#VISITATION_PURPOSE_ID#,#VISITATION_USER_ID#)
</insert>

<update id="updateTreatmentVisitation" parameterClass="map">
update PTRTREATMENT_VISITATION set
TYPE_STATUS_ID=#TYPE_STATUS_ID#,
SUBTYPE_ID=#SUBTYPE_ID#,
CONTACT_ID=#CONTACT_ID#,
TEMPLATE_VERSION_ID=#TEMPLATE_VERSION_ID#,
TURNAROUND_TIME=#TURNAROUND_TIME#,
AREA_ID=#AREA_ID#,
VISITATION_TO_ID=#VISITATION_TO_ID#,
STATE_ID=#STATE_ID#,
PURPOSE_VISIT_ID=#PURPOSE_VISIT_ID#,
EXPECTED_VISITATION_DATE=#EXPECTED_VISITATION_DATE#,
RESIDENT_RACE_ID=#RESIDENT_RACE_ID#,
FAMILY_MEMBERS_NO=#FAMILY_MEMBERS_NO#,
LOCATION=#LOCATION#,
HOUSE_OUTLOOK=#HOUSE_OUTLOOK#,
HOUSE_TYPE=#HOUSE_TYPE#,
HOUSE_INTERIOR=#HOUSE_INTERIOR#,
MBSB_CAR=#MBSB_CAR#,
OTHER_VEHICLES=#OTHER_VEHICLES#,
RESULT_COME_BACK_DATE=#RESULT_COME_BACK_DATE#,
VISITATION_STAFF_NAME=#VISITATION_STAFF_NAME#,
DOCUMENT_ID_1=#DOCUMENT_ID_1#,
DOCUMENT_ID_2=#DOCUMENT_ID_2#,
VISITATION_PURPOSE_ID=#VISITATION_PURPOSE_ID#
where TREATMENT_ID=#ID#
</update>

<resultMap class="hmap" id="getTreatmentVisitation">
<result property="TYPE_STATUS_ID" javaType="long"/>
<result property="SUBTYPE_ID" javaType="long"/>
<result property="CONTACT_ID" javaType="long"/>
<result property="TEMPLATE_VERSION_ID" javaType="long"/>
<result property="TURNAROUND_TIME" javaType="ts"/>
<result property="AREA_ID" javaType="long"/>
<result property="VISITATION_TO_ID" javaType="long"/>
<result property="STATE_ID" javaType="long"/>
<result property="PURPOSE_VISIT_ID" javaType="long"/>
<result property="EXPECTED_VISITATION_DATE" javaType="date"/>
<result property="RESIDENT_RACE_ID" javaType="long"/>
<result property="FAMILY_MEMBERS_NO" javaType="long"/>
<result property="LOCATION" javaType="string"/>
<result property="HOUSE_OUTLOOK" javaType="string"/>
<result property="HOUSE_TYPE" javaType="string"/>
<result property="HOUSE_INTERIOR" javaType="string"/>
<result property="MBSB_CAR" javaType="string"/>
<result property="OTHER_VEHICLES" javaType="string"/>
<result property="RESULT_COME_BACK_DATE" javaType="date"/>
<result property="VISITATION_STAFF_NAME" javaType="string"/>
<result property="LINE_1" javaType="string"/>
<result property="LINE_2" javaType="string"/>
<result property="LINE_3" javaType="string"/>
<result property="LINE_4" javaType="string"/>
<result property="STATE" javaType="string"/>
<result property="AREA" javaType="string"/>
<result property="REMARKS" javaType="string"/>
<result property="CITY" javaType="string"/>
<result property="COUNTRY" javaType="string"/>
<result property="POSTCODE" javaType="string"/>
<result property="DOCUMENT_ID_1" javaType="long"/>
<result property="DOCUMENT_ID_2" javaType="long"/>
<result property="ATTACHED_DOCUMENT_1_FILE_NAME" javaType="string"/>
<result property="ATTACHED_DOCUMENT_2_FILE_NAME" javaType="string"/>
<result property="VISITATION_PURPOSE_ID" javaType="long"/>
</resultMap>

<select id="getTreatmentVisitation" resultMap="getTreatmentVisitation">
select v.TYPE_STATUS_ID,v.SUBTYPE_ID,v.CONTACT_ID,
v.TEMPLATE_VERSION_ID,v.TURNAROUND_TIME,AREA_ID,v.VISITATION_TO_ID,
v.STATE_ID,v.PURPOSE_VISIT_ID,v.EXPECTED_VISITATION_DATE,v.RESIDENT_RACE_ID,
v.FAMILY_MEMBERS_NO,v.LOCATION,v.HOUSE_OUTLOOK,v.HOUSE_TYPE,v.HOUSE_INTERIOR,
v.MBSB_CAR,v.OTHER_VEHICLES,v.RESULT_COME_BACK_DATE,v.VISITATION_STAFF_NAME,
a.line_1, a.line_2, a.line_3, a.line_4, state.description, a.city, a.remarks, a.city, co.description, a.postcode,
v.DOCUMENT_ID_1, v.DOCUMENT_ID_2, up1.file_name, up2.file_name, v.VISITATION_PURPOSE_ID
 from ptrtreatment_visitation v
inner join ptraddress a on a.id=v.contact_id
left join PTRTREATMENT_DOCUMENT_UPLOAD up1 on up1.treatment_id=v.treatment_id and up1.document_id=v.document_id_1
left join PTRTREATMENT_DOCUMENT_UPLOAD up2 on up2.treatment_id=v.treatment_id and up2.document_id=v.document_id_2
left join ptrstate_ref state on state.id=a.state_id
left join ptrcountry_ref co on co.id=a.country_id
where v.TREATMENT_ID=#ID#
union
select v.TYPE_STATUS_ID,v.SUBTYPE_ID,v.CONTACT_ID,
v.TEMPLATE_VERSION_ID,v.TURNAROUND_TIME,AREA_ID,v.VISITATION_TO_ID,
v.STATE_ID,v.PURPOSE_VISIT_ID,v.EXPECTED_VISITATION_DATE,v.RESIDENT_RACE_ID,
v.FAMILY_MEMBERS_NO,v.LOCATION,v.HOUSE_OUTLOOK,v.HOUSE_TYPE,v.HOUSE_INTERIOR,
v.MBSB_CAR,v.OTHER_VEHICLES,v.RESULT_COME_BACK_DATE,v.VISITATION_STAFF_NAME,
a.line_1, a.line_2, a.line_3, a.line_4, state.description, a.city, null as remarks, a.city, co.description, a.postal_code,
v.DOCUMENT_ID_1, v.DOCUMENT_ID_2, up1.file_name, up2.file_name, v.VISITATION_PURPOSE_ID
 from ptrtreatment_visitation v
inner join ptrhost_address a on a.id=v.contact_id
left join PTRTREATMENT_DOCUMENT_UPLOAD up1 on up1.treatment_id=v.treatment_id and up1.document_id=v.document_id_1
left join PTRTREATMENT_DOCUMENT_UPLOAD up2 on up2.treatment_id=v.treatment_id and up2.document_id=v.document_id_2
left join ptrstate_ref state on state.id=a.state_id
left join ptrcountry_ref co on co.id=a.country_id
where v.TREATMENT_ID=#ID#
</select>

<select id="getVisitationState" resultMap="global.ref">
<include refid="pleaseSelectRef" />
		<include refid="fromdual" />
		union
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY from PTRSTATE_REF
</select>

<select id="getVisitationPurpose" resultMap="global.ref">
<include refid="pleaseSelectRef" />
		<include refid="fromdual" />
		union
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY from PTRVISITATION_PURPOSE_REF
</select>

<resultMap class="hmap" id="getVisitationArea" extends="global.ref">
<result property="STATE_ID" javaType="long"/>
</resultMap>

<select id="getVisitationArea" resultMap="getVisitationArea">
<include refid="pleaseSelectRef" />, null
		<include refid="fromdual" />
		union
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY,STATE_ID from PTRAREA_REF
</select>

<select id="getVisitationResidentRace" resultMap="global.ref">
<include refid="pleaseSelectRef" />
		<include refid="fromdual" />
		union
select ID,CODE,DESCRIPTION,DISABLE,SORT_PRIORITY from PTRETHNICITY_REF
</select>

<resultMap class="hmap" id="getTreatmentVisitationCount">
<result property="PREVIOUS_VISITATION_COUNT" javaType="long"/>
</resultMap>

<select id="getTreatmentVisitationCount" resultMap="getTreatmentVisitationCount">
select count(v.treatment_id) from ptrtreatment_visitation v
inner join ptrtreatment_type_status_ref ref on ref.id=v.type_status_id
where v.account_id=#ACCOUNT_ID# and ref.status_id in (15001,15004)
</select>

<!-- 
  <insert id="insertTreatmentImages"  >
    <selectKey resultClass="long" keyProperty="IMAGE_ID">
        <include refid="sequencePrefix"/>ptrtreatment_images_id<include refid="sequenceSuffix"/>
    </selectKey>
 insert into ptrtreatment_images
    (ID, ACCOUNT_ID, DOCUMENT_ID, TREATMENT_ID)
    values
    (#IMAGE_ID#, #ACCOUNT_ID#, #DOCUMENT_ID#, #ID#)
  </insert>
  
    <delete id="deleteTreatmentImages" parameterClass="long">
    delete from ptrtreatment_images where DOCUMENT_ID = #VALUE#
  </delete>
  
    <resultMap id="getTreatmentImages" class="java.util.HashMap">
    <result property="DOCUMENT_ID" javaType="long"/>
  </resultMap>

  <select id="getTreatmentImages" resultMap="getTreatmentImages" parameterClass="map">
    select DOCUMENT_ID from ptrtreatment_images where DOCUMENT_ID = #DOCUMENT_ID#
  </select>
  
   <resultMap id="getTreatmentImagesLists" class="java.util.HashMap">
    <result property="DOCUMENT_ID" javaType="long"/>
  </resultMap>
  
  <select id="getTreatmentImagesLists" resultMap="getTreatmentImagesLists" parameterClass="map">
    select DOCUMENT_ID
    from ptrtreatment_images
    where ACCOUNT_ID = #ACCOUNT_ID# 
    
   <isNotNull property="ID">
  	and  TREATMENT_ID = #ID#
   </isNotNull>
   <isNull  property="ID">
   and TREATMENT_ID is null
   </isNull>
  </select> -->
  
  <resultMap class="hmap" id="getAssignmentIdForTreatmentCall">
  <result property="AGENCY_ASSIGNMENT_ID" javaType="long"/>
  </resultMap>
  
  <select id="getAssignmentIdForTreatmentCall" resultMap="getAssignmentIdForTreatmentCall">
  select ID from PTRACCOUNT_AGENCY_ASSIGNMENT where ACCOUNT_ID=#ACCOUNT_ID# and AGENCY_ID=#AGENCY_ID#
  and STATUS_ID=15007 and acknowledged_date is not null
  </select> 
	
</sqlMap>